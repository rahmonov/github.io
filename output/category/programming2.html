<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
        <title>Home - Jahongir Rahmonov</title>

        <link rel="stylesheet" href="/static/css/main.css" />
        <link rel="stylesheet" href="/static/css/pygment.css" />
        <link rel="stylesheet" href="/static/css/font-awesome.min.css" />
        <link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Jahongir Rahmonov's personal blog" />
        <meta name="author" content="Jahongir Rahmonov" />
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

        <meta property="og:title" content="Home - Jahongir Rahmonov">
        <meta property="og:type" content="website">
        <meta property="og:image" content="/static/images/programming.jpg">
        <meta property="og:url" content="http://rahmonov.github.io">
        <meta property="og:description" content="Jahongir Rahmonov's personal blog about Python, Django, AngularJS and other things.">

        <link href="http://rahmonov.github.io/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Full Atom Feed" />
        <link href="http://rahmonov.github.io/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Jahongir Rahmonov Full RSS Feed" />
        <link href="http://rahmonov.github.io/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Categories Atom Feed" />
</head>

<body id="index" class="home">
    <div class="container">

        <button class="nav js-mobile">
            <i class="fa fa-bars"></i>
        </button>

        <div class="side">
            <div class="logo">
                <a href="/"><img src="/static/images/me.jpg" class="jahon" alt="Jahongir Rahmonov"/></a>
            </div>

            <h2>Jahongir Rahmonov</h2>

            <div class="paragraphs">
<p>
    I hold a BSc hon. in Business Information Systems from <a href="http://wiut.uz/">WIUT</a>.
    I'm currently a Software Developer at <a href="http://mysuperdispatch.com/">Super Dispatch (TechStars '16)</a>
</p>
<p>
    I write about web, books, productivity and other things that are of interest to me.
</p>            </div>


            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/pages/posts.html">Posts</a></li>
                <li><a href="/pages/about.html">About</a></li>
                <li><a href="/pages/about.html#contact">Contact</a></li>
                <li><a href="/feeds/atom.xml" target="_blank">RSS <i class="fa fa-rss"></i></a></li>
            </ul>

            <p class="profiles">
                <a title="GitHub" href="https://github.com/rahmonov" target="_blank"><i class="fa fa-github-square"></i></a>
                <a title="Twitter" href="https://twitter.com/the_rahmonov" target="_blank"><i class="fa fa-twitter-square"></i></a>
                <a title="Facebook" href="https://www.facebook.com/rahmonovj" target="_blank"><i class="fa fa-facebook-official"></i></a>
                <a title="Bitbucket" href="https://bitbucket.org/Jahongir/" target="_blank"><i class="fa fa-bitbucket-square"></i></a>
                <a title="LinkedIn" href="https://www.linkedin.com/in/jahongirrahmonov" target="_blank"><i class="fa fa-linkedin-square"></i></a>
            </p>
        </div>

        <div class="wrap">
            <div class="content">

<h2>Articles in the programming category</h2>

<h4>
    <a href="posts/testcase-vs-transactiontestcase-in-django/">
        11 June 2017
    </a>
</h4>

<h1>TestCase vs TransactionTestCase in Django</h1>

<p>Based on my observation, a lot of developers don't seem to understand the difference between <code>TestCase</code> and <code>TransactionTestCase</code>
in Django and how to use them. In this post, I will try to put the puzzle pieces together and make things clear.</p>
<h2>TestCase class</h2>
<p>Here is what <a href="https://docs.djangoproject.com/en/1.11/topics/testing/tools/#django.test.TestCase">the documentation</a> has to say
about the <code>TestCase</code> class:</p>
<blockquote>
<p>Wraps the tests within two nested atomic() blocks: one for the whole class and one for each test.</p>
</blockquote>
<p>Now imagine that you have a method that must be executed inside a transaction or else it raises an error. You could write a test similar to this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">SomeTestCase</span>(<span class="n">TestCase</span>):

    <span class="n">def</span> <span class="n">test_your_method_raises_error_without_atomic_block</span>(<span class="k">self</span>):
        <span class="n">with</span> <span class="k">self</span>.<span class="n">assertRaises</span>(<span class="n">SomeError</span>):
            <span class="n">your_method</span>()
</pre></div>


<p>In this test, <code>your_method()</code> is called without any transaction and the test is asserting that it raises <code>SomeError</code> because of that.</p>
<p>However, this test will unexpectedly fail! The reason is, you guessed it, TestCase wraps the tests with <code>atomic()</code> blocks 
ALL THE TIME. Thus, <code>your_method()</code> will not raise an error, which is why this test will fail.</p>
<h2>TransactionTestCase to the rescue</h2>
<p>This is where <code>TransactionTestCase</code> should be used. It does not wrap the tests with <code>atomic()</code> block and thus you can test your special 
methods that require a transaction without any problem. The above test will pass with <code>TransactionTestCase</code> now:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">SomeTestCase</span>(<span class="n">TransactionTestCase</span>):

    <span class="n">def</span> <span class="n">test_your_method_raises_error_without_atomic_block</span>(<span class="k">self</span>):
        <span class="n">with</span> <span class="k">self</span>.<span class="n">assertRaises</span>(<span class="n">SomeError</span>):
            <span class="n">your_method</span>()
</pre></div>


<h2>Real Life example</h2>
<p>Let's see a real example now. A queryset method called <a href="https://docs.djangoproject.com/en/1.11/ref/models/querysets/#django.db.models.query.QuerySet.select_for_update">select_for_update()</a> 
is one of those methods that require to be inside a transaction. If you call it without any transaction, it raises an error.</p>
<p>Let's say you have a model called <code>Item</code> and you are calling <code>select_for_update()</code>:</p>
<div class="highlight"><pre><span></span>Item.objects.select_for_update()
</pre></div>


<p>It will immediately raise the following error:</p>
<div class="highlight"><pre><span></span><span class="n">TransactionManagementError</span><span class="o">:</span> <span class="n">select_for_update</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">used</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">a</span> <span class="n">transaction</span><span class="o">.</span>
</pre></div>


<p>Now, let's try to write tests for it with both <code>TestCase</code> and <code>TransactionTestCase</code>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">ItemTestCase</span>(<span class="n">TestCase</span>):
    <span class="n">def</span> <span class="n">setUp</span>(<span class="k">self</span>):
        <span class="k">self</span>.<span class="n">item</span> = <span class="n">Item</span>.<span class="n">objects</span>.<span class="n">create</span>(<span class="nb">name</span>=<span class="s">&#39;hat&#39;</span>)

    <span class="n">def</span> <span class="n">test_select_for_update_raises_an_error_without_transaction</span>(<span class="k">self</span>):
        <span class="n">with</span> <span class="k">self</span>.<span class="n">assertRaises</span>(<span class="n">TransactionManagementError</span>):
            <span class="n">items</span> = <span class="n">Items</span>.<span class="n">objects</span>.<span class="n">select_for_update</span>().<span class="n">filter</span>()
            <span class="nb">print</span>(<span class="n">items</span>)  <span class="c c-Singleline"># needed to actually execute the query because they are lazy</span>
</pre></div>


<p>Try to run the test and you will get the following:</p>
<div class="highlight"><pre><span></span><span class="n">AssertionError</span><span class="o">:</span> <span class="n">TransactionManagementError</span> <span class="n">not</span> <span class="n">raised</span>
</pre></div>


<p>The reason? <code>TestCase</code> wraps the tests with <code>atomic()</code> blocks ALL THE TIME. Good. Glad you remember this. </p>
<p>Now, let's make this test pass with <code>TransactionTestCase</code>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">ItemTestCase</span>(<span class="n">TransactionTestCase</span>):
    <span class="n">def</span> <span class="n">setUp</span>(<span class="k">self</span>):
        <span class="k">self</span>.<span class="n">item</span> = <span class="n">Item</span>.<span class="n">objects</span>.<span class="n">create</span>(<span class="nb">name</span>=<span class="s">&#39;hat&#39;</span>)

    <span class="n">def</span> <span class="n">test_select_for_update_raises_an_error_without_transaction</span>(<span class="k">self</span>):
        <span class="n">with</span> <span class="k">self</span>.<span class="n">assertRaises</span>(<span class="n">TransactionManagementError</span>):
            <span class="n">items</span> = <span class="n">Items</span>.<span class="n">objects</span>.<span class="n">select_for_update</span>().<span class="n">filter</span>()
            <span class="nb">print</span>(<span class="n">items</span>)  <span class="c c-Singleline"># needed to actually execute the query because they are lazy</span>
</pre></div>


<p>and voila! The test passes! Great!</p>
<p>I hope it will clear things out for some people. Let me know in the comments if something is still not clear.</p>
<p>Fight on!</p>

<div class="end">
    <span>
        If you liked what you read, I would really appreciate if you could endorse me on
        <a href="https://www.linkedin.com/in/jahongirrahmonov/">LinkedIn</a>
    </span>
</div>
            </div>
        </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67392250-1', 'auto');
      ga('send', 'pageview');
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="/static/js/mobile.js"></script>

</body>
</html>