<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
          <title> Python ChainMap </title>

        <link rel="stylesheet" href="/static/css/main.css" />
        <link rel="stylesheet" href="/static/css/pygment.css" />
        <link rel="stylesheet" href="/static/css/font-awesome.min.css" />
        <link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="/static/vendor/lightbox2/css/lightbox.min.css">
        <link href="https://afeld.github.io/emoji-css/emoji.css" rel="stylesheet">

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="<p>The comprehensive guide to Python's collections module. Part Two: ChainMap</p>" />
        <meta name="author" content="Jahongir Rahmonov" />
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

<meta property="og:title" content="Python ChainMap">
<meta property="og:type" content="website">
<meta property="og:image" content="/static/images/programming.jpg">
<meta property="og:url" content="http://rahmonov.me/posts/python-chainmap/">
<meta property="og:description" content="<p>The comprehensive guide to Python's collections module. Part Two: ChainMap</p>">

        <link href="http://rahmonov.me/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Full Atom Feed" />
        <link href="http://rahmonov.me/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Jahongir Rahmonov Full RSS Feed" />
        <link href="http://rahmonov.me/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Categories Atom Feed" />


        <meta name="description" content="<p>The comprehensive guide to Python's collections module. Part Two: ChainMap</p>" />

    <meta name="tags" content="python" />
    <meta name="tags" content="collections" />
    <meta name="tags" content="chainmap" />

</head>

<body id="index" class="home">
    <div class="container">

        <button class="nav js-mobile">
            <i class="fa fa-bars"></i>
        </button>

        <div class="side">
            <div class="logo">
                <a href="/"><img src="/static/images/me.jpg" class="jahon" alt="Jahongir Rahmonov"/></a>
            </div>

            <h2>Jahongir Rahmonov</h2>

            <div class="paragraphs">
<p>
    I'm a Software Developer at <a href="http://mysuperdispatch.com/">Super Dispatch (TechStars '16)</a>.
    Avid reader.
    <a href="http://wiut.uz/">WIUT</a> graduate.
    Blogger and an amateur speaker
</p>
<p>
    I write about Python, Django, AngularJS and sometimes something non-technical.
</p>
<p>
    Welcome to my corner <i class="em em-snake"></i>
</p>            </div>

            <form method="get" action="https://www.google.com/search">
                <input name="sitesearch" value="rahmonov.me" type="hidden">
                <input type="text" id="search-query" class="field field-text" required="required" name="q" placeholder="Search..." autocomplete="off">
                <input type="image" src="/static/images/search-icon.png" width="20" height="20" class="search-icon" title="Search via Google" alt="Search via Google">
            </form>

            <ul class="menu">
                <li><a href="/">Home</a></li>
                <li><a href="/pages/about.html">About</a></li>
                <li><a href="/pages/about.html#subscribe">Subscribe</a></li>
                <li><a href="/pages/about.html#contact">Contact</a></li>
                <li><a href="/feeds/atom.xml" target="_blank">RSS <i class="fa fa-rss"></i></a></li>
            </ul>

            <p class="profiles">
                <a title="GitHub" href="https://github.com/rahmonov" target="_blank"><i class="fa fa-github-square"></i></a>
                <a title="StackOverflow" href="https://stackoverflow.com/users/4137194/jahongir-rahmonov?tab=profile" target="_blank"><i class="fa fa-stack-overflow"></i></a>
                <a title="Twitter" href="https://twitter.com/the_rahmonov" target="_blank"><i class="fa fa-twitter-square"></i></a>
                <a title="Facebook" href="https://www.facebook.com/rahmonovj" target="_blank"><i class="fa fa-facebook-official"></i></a>
                <a title="Bitbucket" href="https://bitbucket.org/Jahongir/" target="_blank"><i class="fa fa-bitbucket-square"></i></a>
                <a title="LinkedIn" href="https://www.linkedin.com/in/jahongirrahmonov" target="_blank"><i class="fa fa-linkedin-square"></i></a>
            </p>
        </div>

        <div class="wrap">
            <div class="content">

  <h4>Tue 17 October 2017</h4>

  <h1>Python ChainMap</h1>

  <div class="entry-content">
    <p>In <a href="/posts/python-collections-counter/">Part I</a> of these series about Python's collections module, we talked about the
<code>Counter</code> class and its usage. In this blog post, we will be looking at another class in this module: <code>ChainMap</code>.</p>
<p>Let's say that we are building this awesome web app which is expected to bring us billions of dollars. In this app, we have
two environments: development and production. Each of these environments has its own configurations and we store 
those configs in dictionaries, like this:</p>
<div class="highlight"><pre><span></span><span class="n">development</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;app_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Billions&#39;</span><span class="p">,</span> <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;132.123.33.2&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;development_user&#39;</span><span class="p">}</span>

<span class="n">production</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;222.44.55.16&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;production_user&#39;</span><span class="p">}</span>
</pre></div>


<p>When deploying our app in production, we first look up the <code>production</code> dictionary for a value. If nothing is found, then 
we look it up from the <code>development</code> dictionary. Nothing new, classic config; production overrides development.</p>
<p>To do that, let's create a function called <code>get_config</code>, which takes <code>name</code> as a parameter and returns the result if it finds it, or else <code>None</code>:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">production</span><span class="p">:</span>
<span class="o">...</span>         <span class="k">return</span> <span class="n">production</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="o">...</span>        
<span class="o">...</span>     <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">development</span><span class="p">:</span>
<span class="o">...</span>         <span class="k">return</span> <span class="n">development</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="o">...</span>        
<span class="o">...</span>     <span class="k">return</span> <span class="bp">None</span>
</pre></div>


<p>Let's test it:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">)</span>
<span class="s1">&#39;222.44.55.16&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;db_username&#39;</span><span class="p">)</span>
<span class="s1">&#39;production_user&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;app_name&#39;</span><span class="p">)</span>
<span class="s1">&#39;Billions&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;api_key&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="bp">True</span>
</pre></div>


<p>Looks like it is working well. Please note that this method is for production only. In development, we would first search in the <code>development</code> dict and only
then <code>production</code>.</p>
<p>This is working well, but I don't like it. There has to be a better way. What if I combine them in one dict? Like this:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">development</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;app_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Billions&#39;</span><span class="p">,</span> <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;132.123.33.2&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;development_user&#39;</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">production</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;222.44.55.16&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;production_user&#39;</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">common</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">common</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">development</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">common</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">production</span><span class="p">)</span>
</pre></div>


<p>Looks good. Let's test it:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">common</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">)</span>
<span class="s1">&#39;222.44.55.16&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">common</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db_username&#39;</span><span class="p">)</span>
<span class="s1">&#39;production_user&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">common</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;app_name&#39;</span><span class="p">)</span>
<span class="s1">&#39;Billions&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">common</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_key&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="bp">True</span>
</pre></div>


<p>Cool! It is behaving in the same way as the method we wrote above. However, we did it without having to write a function.</p>
<p>Well, it turns out that there is even better way. Welcome <a href="https://docs.python.org/3/library/collections.html#chainmap-objects">ChainMap</a>!</p>
<p>Basically, what it does is to group multiple dicts into one, updateable view which has the same interface as the ordinary dict (with some additions, of course).
Let's see it in action:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">ChainMap</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">development</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;app_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Billions&#39;</span><span class="p">,</span> <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;132.123.33.2&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;development_user&#39;</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">production</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;222.44.55.16&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;production_user&#39;</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">ChainMap</span><span class="p">(</span><span class="n">production</span><span class="p">,</span> <span class="n">development</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">)</span>
<span class="s1">&#39;222.44.55.16&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db_username&#39;</span><span class="p">)</span>
<span class="s1">&#39;production_user&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;app_name&#39;</span><span class="p">)</span>
<span class="s1">&#39;Billions&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;api_key&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="bp">True</span>
</pre></div>


<p>Awesome! Look how much cleaner it got. With one single line, we accomplished all those things that we did above.</p>
<h2>Other Features</h2>
<p>As I mentioned above, it looks and behaves just like an ordinary dict. However, it has some extra functionality.</p>
<p>You can see the list of comprising dictionaries:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="o">.</span><span class="n">maps</span>
<span class="p">[{</span><span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;222.44.55.16&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;production_user&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;132.123.33.2&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;development_user&#39;</span><span class="p">,</span> <span class="s1">&#39;app_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Billions&#39;</span><span class="p">}]</span>
</pre></div>


<p>You can reverse this order:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="o">.</span><span class="n">maps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">maps</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="o">.</span><span class="n">maps</span>
<span class="p">[{</span><span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;132.123.33.2&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;development_user&#39;</span><span class="p">,</span> <span class="s1">&#39;app_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Billions&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;222.44.55.16&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;production_user&#39;</span><span class="p">}]</span>
</pre></div>


<p>This means that now when look something up, it will first loop up the <code>development</code> dictionary because we reversed the order:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db_username&#39;</span><span class="p">)</span>
<span class="s1">&#39;development_user&#39;</span>
</pre></div>


<p>Cool! </p>
<p>You can also add another dictionary to the group:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">most_important_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;I am the king&#39;</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">new_child</span><span class="p">(</span><span class="n">most_important_config</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db_username&#39;</span><span class="p">)</span>
<span class="s1">&#39;I am the king&#39;</span>
</pre></div>


<p>As you can see, the one we just added was added as the first child and thus it will look it up first.</p>
<p>And lastly, you can see <code>parents</code> of this chain which basically means see all comprising dictionaries except the first one:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">chain</span><span class="o">.</span><span class="n">parents</span>
<span class="n">ChainMap</span><span class="p">({</span><span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;132.123.33.2&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;jahongirr&#39;</span><span class="p">,</span> <span class="s1">&#39;app_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Billions&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;222.44.55.16&#39;</span><span class="p">,</span> <span class="s1">&#39;db_username&#39;</span><span class="p">:</span> <span class="s1">&#39;production_user&#39;</span><span class="p">})</span>
</pre></div>


<p>As you can see here, contents of <code>most_important_config</code> is missing as it is the first element of the <code>ChainMap</code>.</p>
<h2>Conclusion</h2>
<p>In this blog post, we saw what <code>ChainMap</code> is, how to use it and most importantly why to use it. Always learn why something should be used.
Otherwise, it is easy to forget or misuse it.</p>
<p>Fight on!</p>
  </div>

<div class="end">
    <span>
        If you liked what you read, subscribe below. Once in a while, I will send you a list of my new posts.
    </span>

    <div id="popup">
        <p>
            <!-- Begin MailChimp Signup Form -->
            <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
            <style type="text/css">
                #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
                /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
            </style>
            <div id="mc_embed_signup">
            <form action="//rahmonov.us16.list-manage.com/subscribe/post?u=9e30bdfdfe0a7bd7cf7e0d50a&amp;id=af3f3c5f76" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
                <div id="mc_embed_signup_scroll">
            <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
            <div class="mc-field-group">
                <label for="mce-MMERGE1">Name </label>
                <input type="text" value="" name="MMERGE1" class="" id="mce-MMERGE1">
            </div>
            <div class="mc-field-group">
                <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
            </label>
                <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
            </div>
                <div id="mce-responses" class="clear">
                    <div class="response" id="mce-error-response" style="display:none"></div>
                    <div class="response" id="mce-success-response" style="display:none"></div>
                </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9e30bdfdfe0a7bd7cf7e0d50a_af3f3c5f76" tabindex="-1" value=""></div>
                <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
                </div>
            </form>
            </div>
            <!--End mc_embed_signup-->
        </p>
    </div>
</div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'jrahmonov';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
        </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67392250-1', 'auto');
      ga('send', 'pageview');
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="/static/js/mobile.js"></script>
    <script src="/static/vendor/lightbox2/js/lightbox.min.js"></script>
</body>
</html>