<!DOCTYPE html><html lang="en"><head prefix="og: http://ogp.me/ns#"><title>Branch by Abstraction</title><link rel="stylesheet" href="/static/css/main.css"><link rel="stylesheet" href="/static/css/pygment.css"><link rel="stylesheet" href="/static/css/font-awesome.min.css"><link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/static/vendor/lightbox2/css/lightbox.min.css"><link href="https://afeld.github.io/emoji-css/emoji.css" rel="stylesheet"><link rel="shortcut icon" type="image/png" href="/static/images/favicon.png"><meta name="google-site-verification" content="RhKly6bfyZ4vo03CPdY9f-Bg8CuZA0GhTPvCEPsNa2c"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="<p>What is Branch by Abstraction and how to implement it</p>"><meta name="author" content="Jahongir Rahmonov"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta property="og:title" content="Branch by Abstraction"><meta property="og:type" content="website"><meta property="og:image" content="/static/images/programming.jpg"><meta property="og:url" content="http://rahmonov.me/posts/branch-by-abstraction/"><meta property="og:description" content="<p>What is Branch by Abstraction and how to implement it</p>"><link href="http://rahmonov.me/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Full Atom Feed"><link href="http://rahmonov.me/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Jahongir Rahmonov Full RSS Feed"><link href="http://rahmonov.me/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Categories Atom Feed"><meta name="description" content="<p>What is Branch by Abstraction and how to implement it</p>"><meta name="tags" content="programming"><meta name="tags" content="python"><link href="https://unpkg.com/ilyabirman-likely@2/release/likely.css" rel="stylesheet"><script src="https://unpkg.com/ilyabirman-likely@2/release/likely.js" type="text/javascript"></script></head><body id="index" class="home"><div class="container"><button class="nav js-mobile"><i class="fa fa-bars"></i></button><div class="side"><div class="logo"><a href="/"><img src="/static/images/me.jpg" width="150" height="150" class="jahon" alt="Jahongir Rahmonov"></a></div><h2>Jahongir Rahmonov</h2><div class="paragraphs"><p> I'm a Software Developer at <a href="http://mysuperdispatch.com/">Super Dispatch (TechStars '16)</a>. Avid reader. <a href="http://wiut.uz/">WIUT</a> graduate. Blogger and an amateur speaker </p><p> I write about Python, Django, AngularJS and sometimes something non-technical. </p><p> Welcome to my corner <i class="em em-snake"></i></p> </div><form method="get" action="https://www.google.com/search"><input name="sitesearch" value="rahmonov.me" type="hidden"><input type="text" id="search-query" class="field field-text" required name="q" placeholder="Search..." autocomplete="off"><input type="image" src="/static/images/search-icon.png" width="20" height="20" class="search-icon" title="Search via Google" alt="Search via Google"></form><ul class="menu"><li><a href="/">Home</a></li><li><a href="/pages/about.html">About</a></li><li><a href="/pages/about.html#subscribe">Subscribe</a></li><li><a href="/pages/about.html#contact">Contact</a></li><li><a href="/feeds/atom.xml">RSS <i class="fa fa-rss"></i></a></li></ul><p class="profiles"><a title="GitHub" href="https://github.com/rahmonov"><i class="fa fa-github-square"></i></a><a title="StackOverflow" href="https://stackoverflow.com/users/4137194/jahongir-rahmonov?tab=profile"><i class="fa fa-stack-overflow"></i></a><a title="Twitter" href="https://twitter.com/the_rahmonov"><i class="fa fa-twitter-square"></i></a><a title="Facebook" href="https://www.facebook.com/rahmonovj"><i class="fa fa-facebook-official"></i></a><a title="Instagram" href="https://www.instagram.com/rahmonov.me/"><i class="fa fa-instagram"></i></a><a title="LinkedIn" href="https://www.linkedin.com/in/jahongirrahmonov"><i class="fa fa-linkedin-square"></i></a></p></div><div class="wrap"><div class="content"><h4>Sun 08 April 2018</h4><h1>Branch by Abstraction</h1><div class="entry-content"><p>Agile, devops, continuous integration, continuous delivery, scrum, kanban, automation... How many times a day do you hear one of these words? I come across these words every single day whether it be in a book or during a conversation with a co-worker. There is a reason for it though. Everybody is trying to improve their team's performance so that they deliver their products to the market faster than their competition. And these words/techniques/practices, if adopted well, help you achieve this. The best book I can recommend to understand their benefit is <a target="_blank" href="https://www.amazon.com/gp/product/1942788002/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=1942788002&linkCode=as2&tag=rahmonov-20&linkId=74c98a8a14aecc0cada4400461cae8fb">The DevOps Handbook: How to Create World-Class Agility, Reliability, and Security in Technology Organizations</a><img src="//ir-na.amazon-adsystem.com/e/ir?t=rahmonov-20&l=am2&o=1&a=1942788002" width="1" height="1" border="0" alt="The DevOps Handbook" style="border:none !important; margin:0px !important;"></p><p><a target="_blank" href="https://www.amazon.com/gp/product/1942788002/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=1942788002&linkCode=as2&tag=rahmonov-20&linkId=501e009987750090f56e78a1c5224e6a"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=US&ASIN=1942788002&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=rahmonov-20"></a><img src="//ir-na.amazon-adsystem.com/e/ir?t=rahmonov-20&l=am2&o=1&a=1942788002" width="1" height="1" border="0" alt="The DevOps Handbook" style="border:none !important; margin:0px !important;"></p><p>Make sure to read this book if you are at all interested in improving your own and your team's performance.</p><p>If you have read it, you know that one of the biggest and most important pillars of a DevOps team is continuous integration. It means that every commit is integrated to the mainline (master/trunk) branch all the time.</p><p>Now imagine that you have a big improvement to do in your project. Your team decided to switch from <a href="https://github.com/coleifer/peewee">Peewee ORM</a> to <a href="https://www.sqlalchemy.org/">SQLAlchemy</a>. How would one normally go about doing this task? He would open a new branch and do everything there. As this is a big task, it would take him days, if not weeks, to finish it. At the end, he would merge this branch with the master. He would probably have lots of conflicts. He would eventually merge everything and deploy it to production. Users would probably complain that some things are not working at all. Something went wrong while merging the conflicts. It would take him a couple more days to fix everything.</p><p>You can't blame this guy. Merging is difficult and scary. You should blame the process. The team was not continually integrating their code. If they were, they would not have had to merge all the things at the end. They would integrate every commit and as commits are small, it would not be difficult to merge.</p><p><em>"But this is a big task. How can you integrate all your commits to the master all the time and deploy to production? Users would see the incomplete work in progress"</em> I hear you say. Let me show you how you can accomplish this feat painlessly both for you and your users.</p><h2>Feature Toggles</h2><p>The first thing we need to understand is <em>Feature Toggles</em>. This is a simple but powerful concept. Imagine you developed a big feature. But you are too afraid to open it up for thousands of users. You just want to test it with a couple hundred users and gradually increase this number. You can do something like this:</p><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">feature_is_turned_on_for_this_user</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">the_new_interface</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">the_old_interface</span>
</pre></div><p>That is it. <em>Feature Toggles</em> are simply an if statement with a fancy name :)</p><h2>Branch by Abstraction</h2><p>This one is more interesting and is implemented in several steps.</p><p><strong>Step I</strong> is a situation described above. There are some parts of you code that use <a href="https://github.com/coleifer/peewee">Peewee ORM</a> code that you want to replace:</p><div class="gallery medium"><a href="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/first-scenario.jpg" rel="lightbox" title="Flawed Code"><img src="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/first-scenario.jpg" alt="Flawed Code"><span>Flawed Code</span></a></div><p>In <strong>Step II</strong>, we create an abstraction layer for the Peewee code and make one of the clients to work with this abstraction layer using Feature Toggles:</p><div class="gallery medium"><a href="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/second-scenario.jpg" rel="lightbox" title="Abstraction Layer"><img src="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/second-scenario.jpg" alt="Abstraction Layer"><span>Abstraction Layer</span></a></div><p>In <strong>Step III</strong>, we move all the clients to work with this abstraction layer only:</p><div class="gallery medium"><a href="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/third-scenario.jpg" rel="lightbox" title="All clients"><img src="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/third-scenario.jpg" alt="All clients"><span>All clients working with abstraction layer</span></a></div><p>In <strong>Step IV</strong>, we add the new SQLAlchemy code and make one of the clients to work with the new code using Feature Toggles:</p><div class="gallery medium"><a href="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/fourth-scenario.jpg" rel="lightbox" title="New code"><img src="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/fourth-scenario.jpg" alt="New code"><span>One client working with SQLAlchemy</span></a></div><p>In <strong>Step V</strong>, we move all the clients to use the new code:</p><div class="gallery medium"><a href="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/fifth-scenario.jpg" rel="lightbox" title="New code"><img src="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/fifth-scenario.jpg" alt="New code"><span>All clients working with the new code</span></a></div><p>At this point you have successfully and undetectably moved your old Peewee code to the new SQLAlchemy code. If something goes wrong, you can easily bring back the old code until you fix the bug in the new code. How? Feature Toggles, baby!</p><p>If everything is working okay, you may even delete the abstraction layer:</p><div class="gallery medium"><a href="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/sixth-scenario.jpg" rel="lightbox" title="New code"><img src="https://s3.amazonaws.com/rahmonov.me/post-images/branch-by-abstraction/sixth-scenario.jpg" alt="New code"><span>No abstraction layer</span></a></div><p>That is it. No branches, no merges needed. Everything has been done in the master branch.</p><p><em>"This is all good and dandy but some code would be great"</em> I hear you say. Cool. Let's go. But remember that this is an imaginary case and I will be using Python-like pseudo-code.</p><h2>Step I</h2><p>Some parts of your software uses Peewee code that you want to replace:</p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">client_one</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">peewee</span> <span class="o">=</span> <span class="n">Peewee</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">peewee</span><span class="o">.</span><span class="n">get_users</span><span class="p">()</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">client_two</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">peewee</span> <span class="o">=</span> <span class="n">Peewee</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">)</span>
    <span class="n">new_user</span> <span class="o">=</span> <span class="n">peewee</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;rahmonov&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;rockstar&#39;</span><span class="p">)</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">client_three</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">peewee</span> <span class="o">=</span> <span class="n">Peewee</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">peewee</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;rahmonov&#39;</span><span class="p">)</span>
</pre></div><h2>Step II</h2><p>We add an abstraction layer and use it in one of the clients:</p><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DatabaseManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_url</span><span class="p">,</span> <span class="n">use_sqlalchemy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_sqlalchemy</span> <span class="o">=</span> <span class="n">use_sqlalchemy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peewee</span> <span class="o">=</span> <span class="n">Peewee</span><span class="p">(</span><span class="s1">&#39;database_url&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peewee</span><span class="o">.</span><span class="n">get_users</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peewee</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">new_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peewee</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_user</span>


<span class="k">def</span> <span class="nf">client_one</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_users</span><span class="p">()</span>
    <span class="o">...</span>
</pre></div><p>Nothing really changed. We have <code>DatabaseManager</code> that acts just like <code>Pewee</code>. At this point, you should make sure that all your unit tests are passing.</p><h2>Step III</h2><p>We use the new <code>DatabaseManager</code> in all of our clients:</p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">client_one</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_users</span><span class="p">()</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">client_two</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;rahmonov&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;rockstar&#39;</span><span class="p">)</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">client_three</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;rahmonov&#39;</span><span class="p">)</span>
</pre></div><h2>Step IV</h2><p>We add the new SQLAlchemy code to the <code>DatabaseManager</code> class and use it in one of the clients:</p><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DatabaseManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_url</span><span class="p">,</span> <span class="n">use_sqlalchemy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_sqlalchemy</span> <span class="o">=</span> <span class="n">use_sqlalchemy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peewee</span> <span class="o">=</span> <span class="n">Peewee</span><span class="p">(</span><span class="s1">&#39;database_url&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlalchemy</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="s1">&#39;database_url&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqlalchemy</span><span class="p">:</span>
            <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">retrieve_all_users</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peewee</span><span class="o">.</span><span class="n">get_users</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqlalchemy</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">fetch_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peewee</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqlalchemy</span><span class="p">:</span>
            <span class="n">new_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peewee</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_user</span>


<span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sqlalchemy&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;client_one&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;client_two&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">&#39;client_three&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">client_one</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">,</span> <span class="n">use_sqlalchemy</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;sqlalchemy&#39;</span><span class="p">][</span><span class="s1">&#39;client_one&#39;</span><span class="p">])</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_users</span><span class="p">()</span>
    <span class="o">...</span>
</pre></div><p>Note the <code>features</code> dictionary which we are using to show how feature-toggles work. Ideally, those configurations should be stored in a database or something else that you can change without deploying your code. Imagine something goes wrong. You will just have to set the value to <code>False</code> and it will start using the old code automatically without any deployment.</p><h2>Step V</h2><p>We use the new code in all of our client codes:</p><div class="highlight"><pre><span></span><span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sqlalchemy&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;client_one&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;client_two&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;client_three&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">client_one</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">,</span> <span class="n">use_sqlalchemy</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;sqlalchemy&#39;</span><span class="p">][</span><span class="s1">&#39;client_one&#39;</span><span class="p">])</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_users</span><span class="p">()</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">client_two</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">,</span> <span class="n">use_sqlalchemy</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;sqlalchemy&#39;</span><span class="p">][</span><span class="s1">&#39;client_two&#39;</span><span class="p">])</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;rahmonov&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;rockstar&#39;</span><span class="p">)</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">client_three</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseManager</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">,</span> <span class="n">use_sqlalchemy</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;sqlalchemy&#39;</span><span class="p">][</span><span class="s1">&#39;client_three&#39;</span><span class="p">])</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;rahmonov&#39;</span><span class="p">)</span>
</pre></div><p>Make sure that all unit tests pass. If something goes wrong, turn off the feature for everybody, fix the bug and turn it back on.</p><p>When everything is good, go on to the next step:</p><h2>Step V (optional)</h2><p>You can optionally delete the abstraction layer and the dead <code>Peewee</code> code as well.</p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">client_one</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">sqlalchemy</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="s1">&#39;database_url&#39;</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">retrieve_all_users</span><span class="p">()</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">client_two</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">sqlalchemy</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">)</span>
    <span class="n">new_user</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;rahmonov&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;rockstar&#39;</span><span class="p">)</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">client_three</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="n">sqlalchemy</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">fetch_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;rahmonov&#39;</span><span class="p">)</span>
</pre></div><p>That's it! Add small commits and unit tests to this mix and you will have the famous Trunk Based Development implemented, which is a theme for another post.</p><p>Let me know in the comments if you have any questions.</p><p>Fight on!</p></div><div class="pagination clearfix"><a class="prev" href="/posts/static-site-generator/">« Previous</a></ul></div><p><div class="likely likely-big"><div class="facebook">Share</div><div class="twitter" data-via="rahmon0v">Tweet</div><div class="telegram">Send</div><div class="linkedin">Share</div></div></p><div class="end"><span> If you liked what you read, subscribe below. Once in a while, I will send you a list of my new posts. </span><div id="popup"><p><link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css"><style type="text/css">
                #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
                /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
            </style><div id="mc_embed_signup"><form action="//rahmonov.us16.list-manage.com/subscribe/post?u=9e30bdfdfe0a7bd7cf7e0d50a&id=af3f3c5f76" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate><div id="mc_embed_signup_scroll"><div class="indicates-required"><span class="asterisk">*</span> indicates required</div><div class="mc-field-group"><label for="mce-MMERGE1">Name </label><input type="text" value name="MMERGE1" class id="mce-MMERGE1"></div><div class="mc-field-group"><label for="mce-EMAIL">Email Address <span class="asterisk">*</span></label><input type="email" value name="EMAIL" class="required email" id="mce-EMAIL"></div><div id="mce-responses" class="clear"><div class="response" id="mce-error-response" style="display:none"></div><div class="response" id="mce-success-response" style="display:none"></div></div> <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9e30bdfdfe0a7bd7cf7e0d50a_af3f3c5f76" tabindex="-1" value></div><div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div></div></form></div></p></div></div><div id="disqus_thread"></div><script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'jrahmonov';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div><script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67392250-1', 'auto');
      ga('send', 'pageview');
    </script><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script><script src="/static/js/mobile.js"></script><script src="/static/vendor/lightbox2/js/lightbox.min.js"></script><script src="/static/"></script></body></html>