<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
          <title> Nginx Ingress Controller </title>

        <link rel="stylesheet" href="/static/css/main.css" />
        <link rel="stylesheet" href="/static/css/pygment.css" />
        <link rel="stylesheet" href="/static/css/font-awesome.min.css" />
        <link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="/static/vendor/lightbox2/css/lightbox.min.css">
        <link href="https://afeld.github.io/emoji-css/emoji.css" rel="stylesheet">

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="<p>Nginx Ingress Controller Tutorial</p>" />
        <meta name="author" content="Jahongir Rahmonov" />
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

<meta property="og:title" content="Nginx Ingress Controller">
<meta property="og:type" content="website">
<meta property="og:image" content="/static/images/programming.jpg">
<meta property="og:url" content="http://rahmonov.me/posts/nginx-ingress-controller/">
<meta property="og:description" content="<p>Nginx Ingress Controller Tutorial</p>">

        <link href="http://rahmonov.me/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Full Atom Feed" />
        <link href="http://rahmonov.me/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Jahongir Rahmonov Full RSS Feed" />
        <link href="http://rahmonov.me/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Categories Atom Feed" />


        <meta name="description" content="<p>Nginx Ingress Controller Tutorial</p>" />

    <meta name="tags" content="kubernetes" />

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-7110437178205620",
            enable_page_level_ads: true
       });
  </script>

  <link href="https://unpkg.com/ilyabirman-likely@2/release/likely.css" rel="stylesheet">
  <script src="https://unpkg.com/ilyabirman-likely@2/release/likely.js" type="text/javascript"></script>

</head>

<body id="index" class="home">
    <div class="container">

        <button class="nav js-mobile">
            <i class="fa fa-bars"></i>
        </button>

        <div class="side">
            <div class="logo">
                <a href="/"><img src="/static/images/me.jpg" class="jahon" alt="Jahongir Rahmonov"/></a>
            </div>

            <h2>Jahongir Rahmonov</h2>

            <div class="paragraphs">
<p>
    I'm a Software Developer at <a href="http://mysuperdispatch.com/">Super Dispatch (TechStars '16)</a>.
    Avid reader.
    <a href="http://wiut.uz/">WIUT</a> graduate.
    Blogger and an amateur speaker
</p>
<p>
    I write about Python, Django, AngularJS and sometimes something non-technical.
</p>
<p>
    Welcome to my corner <i class="em em-snake"></i>
</p>            </div>

            <form method="get" action="https://www.google.com/search">
                <input name="sitesearch" value="rahmonov.me" type="hidden">
                <input type="text" id="search-query" class="field field-text" required="required" name="q" placeholder="Search..." autocomplete="off">
                <input type="image" src="/static/images/search-icon.png" width="20" height="20" class="search-icon" title="Search via Google" alt="Search via Google">
            </form>

            <ul class="menu">
                <li><a href="/">Home</a></li>
                <li><a href="/pages/about.html">About</a></li>
                <li><a href="/pages/about.html#subscribe">Subscribe</a></li>
                <li><a href="/pages/about.html#contact">Contact</a></li>
                <li><a href="/feeds/atom.xml" target="_blank">RSS <i class="fa fa-rss"></i></a></li>
            </ul>

            <p class="profiles">
                <a title="GitHub" href="https://github.com/rahmonov" target="_blank"><i class="fa fa-github-square"></i></a>
                <a title="StackOverflow" href="https://stackoverflow.com/users/4137194/jahongir-rahmonov?tab=profile" target="_blank"><i class="fa fa-stack-overflow"></i></a>
                <a title="Twitter" href="https://twitter.com/the_rahmonov" target="_blank"><i class="fa fa-twitter-square"></i></a>
                <a title="Facebook" href="https://www.facebook.com/rahmonovj" target="_blank"><i class="fa fa-facebook-official"></i></a>
                <a title="Bitbucket" href="https://bitbucket.org/Jahongir/" target="_blank"><i class="fa fa-bitbucket-square"></i></a>
                <a title="LinkedIn" href="https://www.linkedin.com/in/jahongirrahmonov" target="_blank"><i class="fa fa-linkedin-square"></i></a>
            </p>

              <br>
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
              <!-- sidebar-ad -->
              <ins class="adsbygoogle"
                   style="display:block"
                   data-ad-client="ca-pub-7110437178205620"
                   data-ad-slot="4214071905"
                   data-ad-format="auto"></ins>
              <script>
              (adsbygoogle = window.adsbygoogle || []).push({});
              </script>
        </div>

        <div class="wrap">
            <div class="content">

  <h4>Sat 11 November 2017</h4>

  <h1>Nginx Ingress Controller</h1>

  <div class="entry-content">
    <p>This tutorial assumes that you know the basics of <a href="/posts/introduction-to-kubernetes/">Kubernetes</a>.</p>
<p>We all know that the easiest way to forward the external traffic to your app is to create a service of type <code>LoadBalancer</code>. 
If you are running in a cloud environment such as AWS or GCP, of course. That might be OK for some simple apps. However,
if you want to do SSL termination, path based routing or host based routing, you get stuck. This is where <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a> 
comes in. It will allow you to do everything mentioned above and much more, and looks like this:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test</span>
  <span class="l l-Scalar l-Scalar-Plain">annotations</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">ingress.kubernetes.io/rewrite-target</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">rules</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">foo.bar.com</span>
    <span class="l l-Scalar l-Scalar-Plain">http</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/foo</span>
        <span class="l l-Scalar l-Scalar-Plain">backend</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">serviceName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">s1</span>
          <span class="l l-Scalar l-Scalar-Plain">servicePort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/bar</span>
        <span class="l l-Scalar l-Scalar-Plain">backend</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">serviceName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">s2</span>
          <span class="l l-Scalar l-Scalar-Plain">servicePort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div>


<p>If you try to create an ingress resource from this file, however, you will witness that nothing will happen(except for GKE, which we will get to later). 
In order for such ingress resources to take effect, there has to be something called Ingress Controller running. Basically, Ingress Controllers 
will be constantly watching for changes in Ingress resources and <strong><em>apply</em></strong> the rules outlined in those ingress resources. GKE is an exception to this rule.
When you create a cluster in GKE, it will automatically start its built in ingress controller and you don't have to worry about starting it by yourself.
However, at the time of this writing, it has some limits such as a lack of support for web sockets and it can't force SSL. If these things are 
critical to your app, you might want to consider some other ingress controllers. The most popular ones are the following:</p>
<ul>
<li><a href="https://github.com/kubernetes/ingress-nginx">NGINX ingress controller by Kubernetes</a></li>
<li><a href="https://github.com/nginxinc/kubernetes-ingress">NGINX ingress controller by Nginx Inc</a></li>
<li><a href="https://traefik.io/">Traefik</a></li>
</ul>
<p>I don't have much insight into the difference between two nginx controllers but I think that both of them are good enough. In this tutorial, 
we will be using the one by the Kubernetes team just because it has more stars in GitHub at the time of writing.  </p>
<p>Here is the plan:</p>
<ol>
<li>We will create a cluster on GKE</li>
<li>We will set up an Nginx Ingress Controller</li>
<li>Once it is running, we will deploy a simple app with the help of an Ingress Resource</li>
<li>Be happy</li>
</ol>
<h2>Creating a cluster</h2>
<p>On GKE, it is as easy as this:</p>
<div class="highlight"><pre><span></span>gcloud container clusters create nginx-ingress-controller
</pre></div>


<p>Your mileage will vary if you are using another cloud provider.</p>
<p>It will take a while to create a cluster. After the command is done, you can check if nodes are ready:</p>
<div class="highlight"><pre><span></span>kubectl get nodes
</pre></div>


<p>Output should be:</p>
<div class="highlight"><pre><span></span>gke-nginx-ingress-contro-default-pool-6dbb0978-mkwj   Ready     &lt;none&gt;    1h        v1.7.8-gke.0
gke-nginx-ingress-contro-default-pool-6dbb0978-xvtb   Ready     &lt;none&gt;    1h        v1.7.8-gke.0
gke-nginx-ingress-contro-default-pool-6dbb0978-zp6b   Ready     &lt;none&gt;    1h        v1.7.8-gke.0
</pre></div>


<h2>Setting up the Nginx Ingress Controller</h2>
<p>Our Nginx Ingress Controller will be running in its own namespace. That's why, create <code>namespace.yaml</code> with the following content:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
</pre></div>


<p>Then, create the resource:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">kubectl create -f namespace.yaml</span>
</pre></div>


<p>One of the requirements is to have a default backend and that default backend should handle all url paths and hosts that Nginx Controller does not 
understand (i.e., all the requests that are not mapped with an Ingress). Basically, it should expose <code>/healtz</code> url which returns 200 and all the 
other urls should return 404. Such container has already been written for us. That's why, in this step, we create a default backend deployment and service.
Create <code>default-backend.yaml</code> with the following content:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default-http-backend</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default-http-backend</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default-http-backend</span>
    <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">terminationGracePeriodSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>
      <span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default-http-backend</span>
        <span class="c1"># Any image is permissable as long as:</span>
        <span class="c1"># 1. It serves a 404 page at /</span>
        <span class="c1"># 2. It serves 200 on a /healthz endpoint</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gcr.io/google_containers/defaultbackend:1.4</span>
        <span class="l l-Scalar l-Scalar-Plain">livenessProbe</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">httpGet</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/healthz</span>
            <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
            <span class="l l-Scalar l-Scalar-Plain">scheme</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP</span>
          <span class="l l-Scalar l-Scalar-Plain">initialDelaySeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
          <span class="l l-Scalar l-Scalar-Plain">timeoutSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
        <span class="l l-Scalar l-Scalar-Plain">resources</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">limits</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">cpu</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10m</span>
            <span class="l l-Scalar l-Scalar-Plain">memory</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20Mi</span>
          <span class="l l-Scalar l-Scalar-Plain">requests</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">cpu</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10m</span>
            <span class="l l-Scalar l-Scalar-Plain">memory</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20Mi</span>
<span class="nn">---</span>

<span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default-http-backend</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default-http-backend</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="l l-Scalar l-Scalar-Plain">targetPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default-http-backend</span>
</pre></div>


<p>Create the resources:</p>
<div class="highlight"><pre><span></span>kubectl create -f default-backend.yaml
</pre></div>


<p>Now that our default backend is running, we can create the Nginx Ingress Controller. Create <code>nginx-ingress-controller.yaml</code> with the following content:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx-ingress-controller</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">matchLabels</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
  <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
      <span class="l l-Scalar l-Scalar-Plain">annotations</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">prometheus.io/port</span><span class="p p-Indicator">:</span> <span class="s">&#39;10254&#39;</span>
        <span class="l l-Scalar l-Scalar-Plain">prometheus.io/scrape</span><span class="p p-Indicator">:</span> <span class="s">&#39;true&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx-ingress-controller</span>
          <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.9.0-beta.17</span>
          <span class="l l-Scalar l-Scalar-Plain">args</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/nginx-ingress-controller</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--default-backend-service=$(POD_NAMESPACE)/default-http-backend</span>
          <span class="l l-Scalar l-Scalar-Plain">env</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">POD_NAME</span>
              <span class="l l-Scalar l-Scalar-Plain">valueFrom</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">fieldRef</span><span class="p p-Indicator">:</span>
                  <span class="l l-Scalar l-Scalar-Plain">fieldPath</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">metadata.name</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">POD_NAMESPACE</span>
              <span class="l l-Scalar l-Scalar-Plain">valueFrom</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">fieldRef</span><span class="p p-Indicator">:</span>
                  <span class="l l-Scalar l-Scalar-Plain">fieldPath</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">metadata.namespace</span>
          <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
            <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https</span>
            <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">443</span>
          <span class="l l-Scalar l-Scalar-Plain">livenessProbe</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">failureThreshold</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
            <span class="l l-Scalar l-Scalar-Plain">httpGet</span><span class="p p-Indicator">:</span>
              <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/healthz</span>
              <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10254</span>
              <span class="l l-Scalar l-Scalar-Plain">scheme</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP</span>
            <span class="l l-Scalar l-Scalar-Plain">initialDelaySeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
            <span class="l l-Scalar l-Scalar-Plain">periodSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
            <span class="l l-Scalar l-Scalar-Plain">successThreshold</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
            <span class="l l-Scalar l-Scalar-Plain">timeoutSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
          <span class="l l-Scalar l-Scalar-Plain">readinessProbe</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">failureThreshold</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
            <span class="l l-Scalar l-Scalar-Plain">httpGet</span><span class="p p-Indicator">:</span>
              <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/healthz</span>
              <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10254</span>
              <span class="l l-Scalar l-Scalar-Plain">scheme</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP</span>
            <span class="l l-Scalar l-Scalar-Plain">periodSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
            <span class="l l-Scalar l-Scalar-Plain">successThreshold</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
            <span class="l l-Scalar l-Scalar-Plain">timeoutSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
</pre></div>


<p>Then, create the resource:</p>
<div class="highlight"><pre><span></span>kubectl create -f nginx-ingress-controller.yaml
</pre></div>


<p>This will create a deployment whose pods will have the ports 80 and 443 open for http and https respectively. Now, we can expose this deployment 
so that it will have External IP through which users will connect to our app. For that we will create a service of type <code>LoadBalancer</code>:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">externalTrafficPolicy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Local</span>
  <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="l l-Scalar l-Scalar-Plain">targetPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">443</span>
    <span class="l l-Scalar l-Scalar-Plain">targetPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https</span>
</pre></div>


<p>Create the resource:</p>
<div class="highlight"><pre><span></span>kubectl create -f nginx-controller-service.yaml
</pre></div>


<p>After a little while, if you get all the services, you will see that this service will have an External IP:</p>
<div class="highlight"><pre><span></span>kubectl get svc --namespace<span class="o">=</span>ingress-nginx
</pre></div>


<p>Output should be:</p>
<div class="highlight"><pre><span></span>NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP      PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
ingress-nginx          LoadBalancer   10.59.251.2     104.155.150.97   80:32392/TCP,443:30799/TCP   1h
</pre></div>


<p>We can try that out by using <code>curl</code>. Requests to <code>/</code> should return 404 and to <code>/healthz</code> should return 200:</p>
<div class="highlight"><pre><span></span>curl -v 104.155.150.97/
</pre></div>


<p>Output should be:</p>
<div class="highlight"><pre><span></span>...
&lt; HTTP/1.1 <span class="m">404</span> Not Found
...
</pre></div>


<p>and then:</p>
<div class="highlight"><pre><span></span>curl -v 104.155.150.97/healthz
</pre></div>


<p>will give this:</p>
<div class="highlight"><pre><span></span>...
&lt; HTTP/1.1 <span class="m">200</span> OK
...
</pre></div>


<p>In the last step, we will patch our nginx ingress controller deployment a little bit, as intructed <a href="https://github.com/kubernetes/ingress-nginx/blob/master/deploy/README.md#gce---gke">here</a>.
Create <code>nginx-contoller-patch.yaml</code> with this content:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx-ingress-controller</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">matchLabels</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
  <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ingress-nginx</span>
    <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx-ingress-controller</span>
          <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.9.0-beta.16</span>
          <span class="l l-Scalar l-Scalar-Plain">args</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/nginx-ingress-controller</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--default-backend-service=$(POD_NAMESPACE)/default-http-backend</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--publish-service=$(POD_NAMESPACE)/ingress-nginx</span>
          <span class="l l-Scalar l-Scalar-Plain">env</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">POD_NAME</span>
              <span class="l l-Scalar l-Scalar-Plain">valueFrom</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">fieldRef</span><span class="p p-Indicator">:</span>
                  <span class="l l-Scalar l-Scalar-Plain">fieldPath</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">metadata.name</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">POD_NAMESPACE</span>
              <span class="l l-Scalar l-Scalar-Plain">valueFrom</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">fieldRef</span><span class="p p-Indicator">:</span>
                  <span class="l l-Scalar l-Scalar-Plain">fieldPath</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">metadata.namespace</span>
          <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
            <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https</span>
            <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">443</span>
</pre></div>


<p>This time, use <code>apply</code> because we are patching an existing resource:</p>
<div class="highlight"><pre><span></span>kubectl apply -f nginx-contoller-patch.yaml
</pre></div>


<p>At this point, our nginx ingress controller should be ready. Verify by typing this:</p>
<div class="highlight"><pre><span></span>kubectl get pods --all-namespaces -l <span class="nv">app</span><span class="o">=</span>ingress-nginx
</pre></div>


<p>Output should be:</p>
<div class="highlight"><pre><span></span>NAMESPACE       NAME                                        READY     STATUS    RESTARTS   AGE
ingress-nginx   nginx-ingress-controller-1038678203-x2bjb   1/1       Running   <span class="m">0</span>          2h
</pre></div>


<h2>Deploy an app</h2>
<p>Great! Now that our nginx ingress controller is running, we can deploy our application. It is a simple app called cafe. It has two paths: 
<code>/coffee</code> and <code>/tea</code> which simple prints info about the server they are running on. Let's get started.</p>
<p>Create <code>coffee.yaml</code> with this content:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">coffee-rc</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
  <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">coffee</span>
    <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">coffee</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nginxdemos/hello</span>
        <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">coffee-svc</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">coffee</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="l l-Scalar l-Scalar-Plain">targetPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">coffee</span>
</pre></div>


<p>Create <code>tea.yaml</code> with this content:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tea-rc</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tea</span>
    <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tea</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nginxdemos/hello</span>
        <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tea-svc</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tea</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="l l-Scalar l-Scalar-Plain">targetPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tea</span>
</pre></div>


<p>Create the resources:</p>
<div class="highlight"><pre><span></span>kubectl create -f coffee.yaml
kubectl create -f tea.yaml
</pre></div>


<p>Verify that pods are running:</p>
<div class="highlight"><pre><span></span>kubectl get pods
</pre></div>


<p>Output:</p>
<div class="highlight"><pre><span></span>NAME                         READY     STATUS    RESTARTS   AGE
coffee-rc-3539744749-99qc3   1/1       Running   <span class="m">0</span>          2h
coffee-rc-3539744749-pbwwz   1/1       Running   <span class="m">0</span>          2h
tea-rc-3874333905-g173z      1/1       Running   <span class="m">0</span>          2h
tea-rc-3874333905-n2r25      1/1       Running   <span class="m">0</span>          2h
tea-rc-3874333905-rtsrp      1/1       Running   <span class="m">0</span>          2h
</pre></div>


<p>Cool, now we can create our Ingress object which specifies the path rules:</p>
<div class="highlight"><pre><span></span>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: cafe-ingress-nginx
  annotations:
    kubernetes.io/ingress.class: <span class="s2">&quot;nginx&quot;</span>
spec:
  rules:
  - host: cafe.example.com
    http:
      paths:
      - path: /tea
        backend:
          serviceName: tea-svc
          servicePort: 80
      - path: /coffee
        backend:
          serviceName: coffee-svc
          servicePort: 80
</pre></div>


<p>Note that this resource has an annotation <code>kubernetes.io/ingress.class: "nginx"</code>. This is needed because this ingress is only to be picked up by 
our Nginx Ingress Controller, not the one by GKE.</p>
<p>Create the resource:</p>
<div class="highlight"><pre><span></span>kubectl create -f cafe-ingress.yaml
</pre></div>


<p>It will take a while to take effect. After some time if you attach to the Nginx Ingress Controller pod, you can verify that Nginx configuration was updated:</p>
<div class="highlight"><pre><span></span>kubectl get pods --namespace<span class="o">=</span>ingress-nginx
</pre></div>


<p>Output:</p>
<div class="highlight"><pre><span></span>NAME                                        READY     STATUS    RESTARTS   AGE
nginx-ingress-controller-1038678203-x2bjb   1/1       Running   <span class="m">0</span>          2h
</pre></div>


<p>Attach to its bash:</p>
<div class="highlight"><pre><span></span>kubectl <span class="nb">exec</span> -it nginx-ingress-controller-1038678203-x2bjb bash --namespace<span class="o">=</span>ingress-nginx
</pre></div>


<p>Then, open <code>/etc/nginx/nginx.conf</code> and you will see that the paths <code>/tea</code> and <code>/coffee</code> have been configured there:</p>
<div class="highlight"><pre><span></span>server <span class="o">{</span>
    server_name cafe.example.com <span class="p">;</span>
...    
location /tea
...
location /coffee 
...
</pre></div>


<p>Everything is ready now. The only thing left is to configure DNS. If you are on a UNIX like machine, you can go open <code>/etc/hosts</code> and 
append this:</p>
<div class="highlight"><pre><span></span>104.155.150.97 cafe.example.com
</pre></div>


<p>Make sure to replace <code>104.155.150.97</code> with the IP of your Nginx Ingress Controller's External IP, which you can find by typing this:</p>
<div class="highlight"><pre><span></span>kubectl get svc --namespace<span class="o">=</span>ingress-nginx
</pre></div>


<p>Also, make sure that you flush your DNS cache. If you are on a mac, you can do this:</p>
<div class="highlight"><pre><span></span>sudo dscacheutil -flushcache
</pre></div>


<p>Now, go ahead to <code>cafe.example.com</code> and see the result. Try going to <code>cafe.example.com/tea</code> and <code>cafe.example.com/coffee</code>:</p>
<div class="gallery large">
    <a href="https://s3.amazonaws.com/rahmonov.me/post-images/nginx-ingress-conroller/tea.png" rel="lightbox" title="Cafe">
        <img src="https://s3.amazonaws.com/rahmonov.me/post-images/nginx-ingress-conroller/tea.png" alt="Cafe">
        <span>The Cafe App</span>
    </a>
</div>

<h2>Conclusion</h2>
<p>This is something that I have had tons of problems setting up and getting my heads around. I hope that this will save some time for some of you guys.
Thanks for reading.</p>
<p>Fight on!</p>
<hr>

<p>You may also find this <strong>related</strong> post interesting: <a href="/posts/introduction-to-kubernetes/">Introduction to Kubernetes</a></p>
  </div>

  <div class="pagination clearfix">
         <a class="prev" href="/posts/you-are-a-genius/">« Previous</a>
         <a class="next" href="/posts/python-gil/">Next »</a>
    </ul>
  </div>

<p>
  <div class="likely likely-big">
    <div class="facebook">Share</div>
    <div class="twitter" data-via="rahmon0v">Tweet</div>
    <div class="telegram">Send</div>
    <div class="linkedin">Share</div>
  </div>
</p>

<div class="end">
    <span>
        If you liked what you read, subscribe below. Once in a while, I will send you a list of my new posts.
    </span>

    <div id="popup">
        <p>
            <!-- Begin MailChimp Signup Form -->
            <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
            <style type="text/css">
                #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
                /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
            </style>
            <div id="mc_embed_signup">
            <form action="//rahmonov.us16.list-manage.com/subscribe/post?u=9e30bdfdfe0a7bd7cf7e0d50a&amp;id=af3f3c5f76" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
                <div id="mc_embed_signup_scroll">
            <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
            <div class="mc-field-group">
                <label for="mce-MMERGE1">Name </label>
                <input type="text" value="" name="MMERGE1" class="" id="mce-MMERGE1">
            </div>
            <div class="mc-field-group">
                <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
            </label>
                <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
            </div>
                <div id="mce-responses" class="clear">
                    <div class="response" id="mce-error-response" style="display:none"></div>
                    <div class="response" id="mce-success-response" style="display:none"></div>
                </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9e30bdfdfe0a7bd7cf7e0d50a_af3f3c5f76" tabindex="-1" value=""></div>
                <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
                </div>
            </form>
            </div>
            <!--End mc_embed_signup-->
        </p>
    </div>
</div>    <div style="text-align: center">
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <!-- above-comments -->
        <ins class="adsbygoogle"
             style="display:inline-block;width:728px;height:90px"
             data-ad-client="ca-pub-7110437178205620"
             data-ad-slot="6262754395"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'jrahmonov';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
        </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67392250-1', 'auto');
      ga('send', 'pageview');
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="/static/js/mobile.js"></script>
    <script src="/static/vendor/lightbox2/js/lightbox.min.js"></script>
</body>
</html>