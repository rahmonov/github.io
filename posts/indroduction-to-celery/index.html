<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
          <title> Introduction to Celery - Jahongir Rahmonov </title>

        <link rel="stylesheet" href="/static/css/main.css" />
        <link rel="stylesheet" href="/static/css/pygment.css" />
        <link rel="stylesheet" href="/static/css/font-awesome.min.css" />
        <link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Jahongir Rahmonov's personal blog" />
        <meta name="author" content="Jahongir Rahmonov" />
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

<meta property="og:title" content="Introduction to Celery - Jahongir Rahmonov">
<meta property="og:type" content="website">
<meta property="og:image" content="/static/images/programming.jpg">
<meta property="og:url" content="http://rahmonov.github.io/posts/indroduction-to-celery/">
<meta property="og:description" content="<p>Introduction to Celery: a simple, flexible and reliable distributed task queue</p>">

        <link href="http://rahmonov.github.io/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Full Atom Feed" />
        <link href="http://rahmonov.github.io/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Jahongir Rahmonov Full RSS Feed" />
        <link href="http://rahmonov.github.io/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Categories Atom Feed" />



    <meta name="tags" content="celery" />
    <meta name="tags" content="pyton" />
    <meta name="tags" content="asynch" />
    <meta name="tags" content="threads" />

</head>

<body id="index" class="home">
    <div class="container">

        <button class="nav js-mobile">
            <i class="fa fa-bars"></i>
        </button>

        <div class="side">
            <div class="logo">
                <a href="/"><img src="/static/images/me.jpg" class="jahon" alt="Jahongir Rahmonov"/></a>
            </div>

            <h2>Jahongir Rahmonov</h2>

            <div class="paragraphs">
<p>
    I study Business Information Systems at <a href="http://wiut.uz/">WIUT</a>.
    I'm currently a Software Engineer at <a href="http://shift.uz/">Shift Technologies</a>
    and am living in Tashkent, Uzbekistan.
</p>
<p>
    I write about web, mobile and other things that are of interest to me.
</p>            </div>


            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/pages/posts.html">Posts</a></li>
                <li><a href="/pages/about.html">About</a></li>
                <li><a href="/pages/about.html#contact">Contact</a></li>
                <li><a href="/feeds/atom.xml" target="_blank">RSS <i class="fa fa-rss"></i></a></li>
            </ul>

            <p class="profiles">
                <a title="GitHub" href="https://github.com/rahmonov" target="_blank"><i class="fa fa-github-square"></i></a>
                <a title="Twitter" href="https://twitter.com/the_rahmonov" target="_blank"><i class="fa fa-twitter-square"></i></a>
                <a title="Facebook" href="https://www.facebook.com/rahmonovj" target="_blank"><i class="fa fa-facebook-official"></i></a>
                <a title="Bitbucket" href="https://bitbucket.org/Jahongir/" target="_blank"><i class="fa fa-bitbucket-square"></i></a>
                <a title="LinkedIn" href="https://www.linkedin.com/in/jahongirrahmonov" target="_blank"><i class="fa fa-linkedin-square"></i></a>
            </p>
        </div>

        <div class="wrap">
            <div class="content">

  <h4>Pay 28 Aprel 2016</h4>

  <h1>Introduction to Celery</h1>

  <div class="entry-content">
    <p>According to the <a href="http://docs.celeryproject.org/en/latest/index.html">docs</a>, Celery is a simple, 
flexible and reliable distributed system to process vast amounts of messages, while providing 
operations with the tools required to maintain such a system.</p>
<p>It’s a task queue with focus on real-time processing, while also supporting task scheduling.</p>
<h2>What is it used for?</h2>
<p>It is mainly used for the following things:</p>
<ul>
<li>Running something in the background</li>
<li>Asynchronous execution of code</li>
<li>Scheduling periodic work</li>
</ul>
<h2>Use case example</h2>
<p>Your web app needs to send an email. That is a very slow operation. While users can put up with 4 or 5
seconds until an email is sent, it might leave a bad impression on them. Solution? Celery (singing...
"I came in like a wrecking ball...(by Miley Cyrus)")! It will take this operation out of the main thread and executes it
in the background. This gives the user the impression of good performance and “snappiness”, even 
though the real work might actually take some time.</p>
<p>Read <a href="http://decafbad.com/blog/2008/07/04/queue-everything-and-delight-everyone/">Queue everything and delight everyone</a>
for additional info on why task queues can be useful.</p>
<h2>Get started</h2>
<p>Now that we know what Celery is and what it is used for, let's jump in and see how to use it with Django
(other cases should be similar). We will see how to send an email with Celery.</p>
<p>First, create a new <code>proj/proj/celery.py</code> module that defines a Celery instance</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c"># set the default Django settings module for the &#39;celery&#39; program.</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">,</span> <span class="s">&#39;proj.settings&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>  <span class="c"># noqa</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">&#39;proj&#39;</span><span class="p">)</span>

<span class="c"># Using a string here means the worker will not have to</span>
<span class="c"># pickle the object when using Windows.</span>
<span class="n">app</span><span class="o">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s">&#39;django.conf:settings&#39;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">autodiscover_tasks</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">)</span>
</pre></div>


<p>Then, import this app in <code>proj/proj/__init__.py</code></p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="c"># This will make sure the app is always imported when</span>
<span class="c"># Django starts so that shared_task will use this app.</span>
<span class="kn">from</span> <span class="nn">.celery</span> <span class="kn">import</span> <span class="n">app</span> <span class="k">as</span> <span class="n">celery_app</span>  <span class="c"># noqa</span>
</pre></div>


<p>Then, create an ordinary function</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">send_email</span><span class="p">():</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Message&#39;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;jrahmonov2@gmail.com&#39;</span><span class="p">])</span>  
    <span class="n">message</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Email is sent&#39;</span><span class="p">)</span>
</pre></div>


<p>Note that tasks are normally placed in <code>tasks.py</code> file inside django apps:</p>
<div class="highlight"><pre>- app1/
    - app1/tasks.py
    - app1/models.py
- app2/
    - app2/tasks.py
    - app2/models.py
</pre></div>


<p>However, for this simple example, I put the <code>send_email()</code> function inside <code>proj/proj/celery.py</code></p>
<p>Now, let's check our function by executing it in the shell</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">celery_demo.celery</span> <span class="kn">import</span> <span class="n">send_email</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">send_email</span><span class="p">()</span>
</pre></div>


<p>After a couple of seconds, you will see <code>Email is sent</code> message as long as you properly configured email settings.
But these seconds are too long when you can easily get rid of them. To do that, we now need to transform
this function into a celery task by simply using <code>@shared_task</code> decorator:</p>
<div class="highlight"><pre><span class="nd">@shared_task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">send_email</span><span class="p">():</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Message&#39;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;jrahmonov2@gmail.com&#39;</span><span class="p">])</span>
    <span class="n">message</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Email is sent&#39;</span><span class="p">)</span>
</pre></div>


<p>Now, we start celery in the command line by executing this:</p>
<div class="highlight"><pre>celery -A celery_demo worker -l info
</pre></div>


<p>Now, we call our task from the shell with <code>delay()</code> method of celery:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">celery_demo.celery</span> <span class="kn">import</span> <span class="n">send_email</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">send_email</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</pre></div>


<p>You will immediately see that the method returned! That means that users will see the results right away!
If you check you Celery logs, you will see something like this:</p>
<div class="highlight"><pre><span class="k">[2016-04-28 06:54:59,920: INFO/MainProcess] Received task: celery_demo.celery.send_email[1d2b9446-4791-4da4-8136-ee74d78cf394]</span>
<span class="err">[2016-04-28</span> <span class="err">06:55:02,470:</span> <span class="err">WARNING/Worker-3]</span> <span class="err">Email</span> <span class="err">is</span> <span class="err">sent</span>
<span class="err">[2016-04-28</span> <span class="err">06:55:02,471:</span> <span class="err">INFO/MainProcess]</span> <span class="err">Task</span> <span class="err">celery_demo.celery.send_email[1d2b9446-4791-4da4-8136-ee74d78cf394]</span> <span class="err">succeeded</span> <span class="err">in</span> <span class="err">2.550240921s:</span> <span class="err">None</span>
</pre></div>


<p>Awesome! Pretty fast!</p>
<p>This was a simple example of how to use Celery. Please note that this post does not discuss the installation process of Celery (or RabbitMQ) and is only
intended to serve as a fast introduction to the tool. </p>
<p>In the next post, I will discuss how Celery can be used for periodic tasks (think cron jobs)</p>
<p>Fight on!</p>
  </div>

<div class="end">
    <span>
        You're awesome for reading this. You should follow me on
        <a href="https://twitter.com/the_rahmonov" target="_blank">Twitter</a>
        and
        <a href="https://github.com/rahmonov" target="_blank">GitHub</a>.
    </span>
</div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'jrahmonov';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
        </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67392250-1', 'auto');
      ga('send', 'pageview');
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="/static/js/mobile.js"></script>

</body>
</html>