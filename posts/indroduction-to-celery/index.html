<!DOCTYPE html><html lang="en"><head prefix="og: http://ogp.me/ns#"><title>Introduction to Celery</title><link rel="stylesheet" href="/static/css/main.css"><link rel="stylesheet" href="/static/css/pygment.css"><link rel="stylesheet" href="/static/css/font-awesome.min.css"><link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/static/vendor/lightbox2/css/lightbox.min.css"><link href="https://afeld.github.io/emoji-css/emoji.css" rel="stylesheet"><link rel="shortcut icon" type="image/png" href="/static/images/favicon.png"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="<p>Introduction to Celery: a simple, flexible and reliable distributed task queue</p>"><meta name="author" content="Jahongir Rahmonov"><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"><meta property="og:title" content="Introduction to Celery"><meta property="og:type" content="website"><meta property="og:image" content="/static/images/programming.jpg"><meta property="og:url" content="http://rahmonov.me/posts/indroduction-to-celery/"><meta property="og:description" content="<p>Introduction to Celery: a simple, flexible and reliable distributed task queue</p>"><link href="http://rahmonov.me/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Full Atom Feed"><link href="http://rahmonov.me/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Jahongir Rahmonov Full RSS Feed"><link href="http://rahmonov.me/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Categories Atom Feed"><meta name="description" content="<p>Introduction to Celery: a simple, flexible and reliable distributed task queue</p>"><meta name="tags" content="celery"><meta name="tags" content="pyton"><meta name="tags" content="asynch"><meta name="tags" content="threads"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-7110437178205620",
            enable_page_level_ads: true
       });
  </script><link href="https://unpkg.com/ilyabirman-likely@2/release/likely.css" rel="stylesheet"><script src="https://unpkg.com/ilyabirman-likely@2/release/likely.js" type="text/javascript"></script></head><body id="index" class="home"><div class="container"><button class="nav js-mobile"><i class="fa fa-bars"></i></button><div class="side"><div class="logo"><a href="/"><img src="/static/images/me.jpg" width="150px" height="150px" class="jahon" alt="Jahongir Rahmonov"></a></div><h2>Jahongir Rahmonov</h2><div class="paragraphs"><p> I'm a Software Developer at <a href="http://mysuperdispatch.com/">Super Dispatch (TechStars '16)</a>. Avid reader. <a href="http://wiut.uz/">WIUT</a> graduate. Blogger and an amateur speaker </p><p> I write about Python, Django, AngularJS and sometimes something non-technical. </p><p> Welcome to my corner <i class="em em-snake"></i></p> </div><form method="get" action="https://www.google.com/search"><input name="sitesearch" value="rahmonov.me" type="hidden"><input type="text" id="search-query" class="field field-text" required name="q" placeholder="Search..." autocomplete="off"><input type="image" src="/static/images/search-icon.png" width="20" height="20" class="search-icon" title="Search via Google" alt="Search via Google"></form><ul class="menu"><li><a href="/">Home</a></li><li><a href="/pages/about.html">About</a></li><li><a href="/pages/about.html#subscribe">Subscribe</a></li><li><a href="/pages/about.html#contact">Contact</a></li><li><a href="/feeds/atom.xml">RSS <i class="fa fa-rss"></i></a></li></ul><p class="profiles"><a title="GitHub" href="https://github.com/rahmonov"><i class="fa fa-github-square"></i></a><a title="StackOverflow" href="https://stackoverflow.com/users/4137194/jahongir-rahmonov?tab=profile"><i class="fa fa-stack-overflow"></i></a><a title="Twitter" href="https://twitter.com/the_rahmonov"><i class="fa fa-twitter-square"></i></a><a title="Facebook" href="https://www.facebook.com/rahmonovj"><i class="fa fa-facebook-official"></i></a><a title="Instagram" href="https://www.instagram.com/rahmonov.me/"><i class="fa fa-instagram"></i></a><a title="LinkedIn" href="https://www.linkedin.com/in/jahongirrahmonov"><i class="fa fa-linkedin-square"></i></a></p><br><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7110437178205620" data-ad-slot="4214071905" data-ad-format="auto"></ins><script>
              (adsbygoogle = window.adsbygoogle || []).push({});
              </script></div><div class="wrap"><div class="content"><h4>Thu 28 April 2016</h4><h1>Introduction to Celery</h1><div class="entry-content"><p>According to the <a href="http://docs.celeryproject.org/en/latest/index.html">docs</a>, Celery is a simple, flexible and reliable distributed system to process vast amounts of messages, while providing operations with the tools required to maintain such a system.</p><p>It’s a task queue with focus on real-time processing, while also supporting task scheduling.</p><h2>What is it used for?</h2><p>It is mainly used for the following things:</p><ul><li>Running something in the background</li><li>Asynchronous execution of code</li><li>Scheduling periodic work</li></ul><h2>Use case example</h2><p>Your web app needs to send an email. That is a very slow operation. While users can put up with 4 or 5 seconds until an email is sent, it might leave a bad impression on them. Solution? Celery (singing... "I came in like a wrecking ball...(by Miley Cyrus)")! It will take this operation out of the main thread and executes it in the background. This gives the user the impression of good performance and “snappiness”, even though the real work might actually take some time.</p><p>Read <a href="http://decafbad.com/blog/2008/07/04/queue-everything-and-delight-everyone/">Queue everything and delight everyone</a> for additional info on why task queues can be useful.</p><h2>Get started</h2><p>Now that we know what Celery is and what it is used for, let's jump in and see how to use it with Django (other cases should be similar). We will see how to send an email with Celery.</p><p>First, create a new <code>proj/proj/celery.py</code> module that defines a Celery instance</p><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c1"># set the default Django settings module for the &#39;celery&#39; program.</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">,</span> <span class="s1">&#39;proj.settings&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>  <span class="c1"># noqa</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;proj&#39;</span><span class="p">)</span>

<span class="c1"># Using a string here means the worker will not have to</span>
<span class="c1"># pickle the object when using Windows.</span>
<span class="n">app</span><span class="o">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s1">&#39;django.conf:settings&#39;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">autodiscover_tasks</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">)</span>
</pre></div><p>Then, import this app in <code>proj/proj/__init__.py</code></p><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="c1"># This will make sure the app is always imported when</span>
<span class="c1"># Django starts so that shared_task will use this app.</span>
<span class="kn">from</span> <span class="nn">.celery</span> <span class="kn">import</span> <span class="n">app</span> <span class="k">as</span> <span class="n">celery_app</span>  <span class="c1"># noqa</span>
</pre></div><p>Then, create an ordinary function</p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">send_email</span><span class="p">():</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="s1">&#39;Message&#39;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jrahmonov2@gmail.com&#39;</span><span class="p">])</span>  
    <span class="n">message</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Email is sent&#39;</span><span class="p">)</span>
</pre></div><p>Note that tasks are normally placed in <code>tasks.py</code> file inside django apps:</p><div class="highlight"><pre><span></span>- app1/
    - app1/tasks.py
    - app1/models.py
- app2/
    - app2/tasks.py
    - app2/models.py
</pre></div><p>However, for this simple example, I put the <code>send_email()</code> function inside <code>proj/proj/celery.py</code></p><p>Now, let's check our function by executing it in the shell</p><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">proj.celery</span> <span class="kn">import</span> <span class="n">send_email</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">send_email</span><span class="p">()</span>
</pre></div><p>After a couple of seconds, you will see <code>Email is sent</code> message as long as you properly configured email settings. But these seconds are too long when you can easily get rid of them. To do that, we now need to transform this function into a celery task by simply using <code>@shared_task</code> decorator:</p><div class="highlight"><pre><span></span><span class="nd">@shared_task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">send_email</span><span class="p">():</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="s1">&#39;Message&#39;</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jrahmonov2@gmail.com&#39;</span><span class="p">])</span>
    <span class="n">message</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Email is sent&#39;</span><span class="p">)</span>
</pre></div><p>Now, we start celery in the command line by executing this:</p><div class="highlight"><pre><span></span>celery -A proj worker -l info
</pre></div><p>Now, we call our task from the shell with <code>delay()</code> method of celery:</p><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">proj.celery</span> <span class="kn">import</span> <span class="n">send_email</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">send_email</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</pre></div><p>You will immediately see that the method returned! That means that users will see the results right away! If you check you Celery logs, you will see something like this:</p><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2016</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">28</span> <span class="mo">06</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">59</span><span class="p">,</span><span class="mi">920</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">proj</span><span class="o">.</span><span class="n">celery</span><span class="o">.</span><span class="n">send_email</span><span class="p">[</span><span class="mi">1</span><span class="n">d2b9446</span><span class="o">-</span><span class="mi">4791</span><span class="o">-</span><span class="mi">4</span><span class="n">da4</span><span class="o">-</span><span class="mi">8136</span><span class="o">-</span><span class="n">ee74d78cf394</span><span class="p">]</span>
<span class="p">[</span><span class="mi">2016</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">28</span> <span class="mo">06</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mo">02</span><span class="p">,</span><span class="mi">470</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">Worker</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="n">Email</span> <span class="ow">is</span> <span class="n">sent</span>
<span class="p">[</span><span class="mi">2016</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">28</span> <span class="mo">06</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mo">02</span><span class="p">,</span><span class="mi">471</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Task</span> <span class="n">proj</span><span class="o">.</span><span class="n">celery</span><span class="o">.</span><span class="n">send_email</span><span class="p">[</span><span class="mi">1</span><span class="n">d2b9446</span><span class="o">-</span><span class="mi">4791</span><span class="o">-</span><span class="mi">4</span><span class="n">da4</span><span class="o">-</span><span class="mi">8136</span><span class="o">-</span><span class="n">ee74d78cf394</span><span class="p">]</span> <span class="n">succeeded</span> <span class="ow">in</span> <span class="mf">2.550240921</span><span class="n">s</span><span class="p">:</span> <span class="bp">None</span>
</pre></div><p>Awesome! Pretty fast!</p><p>This was a simple example of how to use Celery. Please note that this post does not discuss the installation process of Celery (or RabbitMQ) and is only intended to serve as a fast introduction to the tool. </p><p>In the next post, I will discuss how Celery can be used for periodic tasks (think cron jobs)</p><p>Fight on!</p></div><div class="pagination clearfix"><a class="prev" href="/posts/pomodoro-technique/">« Previous</a><a class="next" href="/posts/periodic-tasks-with-celery/">Next »</a></ul></div><p><div class="likely likely-big"><div class="facebook">Share</div><div class="twitter" data-via="rahmon0v">Tweet</div><div class="telegram">Send</div><div class="linkedin">Share</div></div></p><div class="end"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7110437178205620" data-ad-slot="4409204211" data-ad-format="auto"></ins><script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script><span> If you liked what you read, subscribe below. Once in a while, I will send you a list of my new posts. </span><div id="popup"><p><link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css"><style type="text/css">
                #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
                /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
            </style><div id="mc_embed_signup"><form action="//rahmonov.us16.list-manage.com/subscribe/post?u=9e30bdfdfe0a7bd7cf7e0d50a&id=af3f3c5f76" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate><div id="mc_embed_signup_scroll"><div class="indicates-required"><span class="asterisk">*</span> indicates required</div><div class="mc-field-group"><label for="mce-MMERGE1">Name </label><input type="text" value name="MMERGE1" class id="mce-MMERGE1"></div><div class="mc-field-group"><label for="mce-EMAIL">Email Address <span class="asterisk">*</span></label><input type="email" value name="EMAIL" class="required email" id="mce-EMAIL"></div><div id="mce-responses" class="clear"><div class="response" id="mce-error-response" style="display:none"></div><div class="response" id="mce-success-response" style="display:none"></div></div> <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9e30bdfdfe0a7bd7cf7e0d50a_af3f3c5f76" tabindex="-1" value></div><div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div></div></form></div></p></div></div> <div style="text-align: center"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-7110437178205620" data-ad-slot="6262754395"></ins><script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script></div><div id="disqus_thread"></div><script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'jrahmonov';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div><script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67392250-1', 'auto');
      ga('send', 'pageview');
    </script><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script><script src="/static/js/mobile.js"></script><script src="/static/vendor/lightbox2/js/lightbox.min.js"></script></body></html>