<!DOCTYPE html><html lang="en"><head prefix="og: http://ogp.me/ns#"><title>How to write a Python web framework. Part IV.</title><link rel="stylesheet" href="/static/css/main.css"><link rel="stylesheet" href="/static/css/pygment.css"><link rel="stylesheet" href="/static/css/font-awesome.min.css"><link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/static/vendor/lightbox2/css/lightbox.min.css"><link href="https://afeld.github.io/emoji-css/emoji.css" rel="stylesheet"><link rel="shortcut icon" type="image/png" href="/static/images/favicon.png"><meta name="google-site-verification" content="RhKly6bfyZ4vo03CPdY9f-Bg8CuZA0GhTPvCEPsNa2c"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="<p>The fourth post of the series where we will be writing our own Python framework just like Flask and Django.</p>"><meta name="author" content="Jahongir Rahmonov"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta property="og:title" content="How to write a Python web framework. Part IV."><meta property="og:type" content="website"><meta property="og:image" content="/static/images/programming.jpg"><meta property="og:url" content="http://rahmonov.me/posts/write-python-framework-part-four/"><meta property="og:description" content="<p>The fourth post of the series where we will be writing our own Python framework just like Flask and Django.</p>"><link href="http://rahmonov.me/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Full Atom Feed"><link href="http://rahmonov.me/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Jahongir Rahmonov Full RSS Feed"><link href="http://rahmonov.me/feeds/python.atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Categories Atom Feed"><meta name="description" content="<p>The fourth post of the series where we will be writing our own Python framework just like Flask and Django.</p>"><meta name="tags" content="programming"><meta name="tags" content="python"><link href="https://unpkg.com/ilyabirman-likely@2/release/likely.css" rel="stylesheet"><script src="https://unpkg.com/ilyabirman-likely@2/release/likely.js" type="text/javascript"></script></head><body id="index" class="home"><div class="container"><button class="nav js-mobile"><i class="fa fa-bars"></i></button><div class="side"><div class="logo"><a href="/"><img src="/static/images/me.jpg" width="150" height="150" class="jahon" alt="Jahongir Rahmonov"></a></div><h2>Jahongir Rahmonov</h2><div class="paragraphs"><p> I'm a Software Developer at <a href="http://mysuperdispatch.com/">Super Dispatch (TechStars '16)</a>. Avid reader. <a href="http://wiut.uz/">WIUT</a> graduate. Blogger and an amateur speaker </p><p> I write about Python, Django, AngularJS and sometimes something non-technical. </p><p> Welcome to my corner <i class="em em-snake"></i></p> </div><form method="get" action="https://www.google.com/search"><input name="sitesearch" value="rahmonov.me" type="hidden"><input type="text" id="search-query" class="field field-text" required name="q" placeholder="Search..." autocomplete="off"><input type="image" src="/static/images/search-icon.png" width="20" height="20" class="search-icon" title="Search via Google" alt="Search via Google"></form><ul class="menu"><li><a href="/">Home</a></li><li><a href="/pages/about.html">About</a></li><li><a href="/pages/about.html#subscribe">Subscribe</a></li><li><a href="/pages/about.html#contact">Contact</a></li><li><a href="/feeds/atom.xml">RSS <i class="fa fa-rss"></i></a></li></ul><p class="profiles"><a title="GitHub" href="https://github.com/rahmonov"><i class="fa fa-github-square"></i></a><a title="StackOverflow" href="https://stackoverflow.com/users/4137194/jahongir-rahmonov?tab=profile"><i class="fa fa-stack-overflow"></i></a><a title="Twitter" href="https://twitter.com/rahmon0v"><i class="fa fa-twitter-square"></i></a><a title="LinkedIn" href="https://www.linkedin.com/in/jahongirrahmonov"><i class="fa fa-linkedin-square"></i></a></p></div><div class="wrap"><div class="content"><h4>Mon 25 March 2019</h4><h1>How to write a Python web framework. Part IV.</h1><div class="entry-content"><p><em>Check out Part I <a href="/posts/write-python-framework-part-one/">here</a></em><br><em>Check out Part II <a href="/posts/write-python-framework-part-two/">here</a></em><br><em>Check out Part III <a href="/posts/write-python-framework-part-three/">here</a></em></p><blockquote><p>A little reminder that this series is based on the <a href="https://github.com/rahmonov/alcazar">Alcazar framework</a> that I am writing for learning purposes. If you liked this series, show some love by starring the <a href="https://github.com/rahmonov/alcazar">repo</a>.</p></blockquote><p>In the previous blog posts in the series, we started writing our own Python framework and implemented the following features:</p><ul><li>WSGI compatible</li><li>Request Handlers</li><li>Routing: simple and parameterized</li><li>Check for duplicate routes</li><li>Class Based Handlers</li><li>Unit tests</li><li>Test Client</li><li>Alternative way to add routes (like Django)</li><li>Support for templates</li></ul><p>In this part, we will add a few more awesome features to the list:</p><ul><li>Custom exception handler</li><li>Support for static files</li><li>Middleware</li></ul><h2>Custom exception handler</h2><p>Exceptions inevitably happen. Users may do something that we didn't expect. We may write some code that doesn't work on some occasions. Users may go to a non existent page. With what we have right now, if some exception happens, we show a big ugly <code>Internal Server Error</code> message. Instead, we could show some nice one. Something along the lines of <code>Oops! Something went wrong.</code> or <code>Please, contact our customer support</code>. For that, we need to be able to catch those exceptions and handle them however we want.</p><p>It will look like this:</p><div class="highlight"><pre><span></span><span class="c1"># app.py</span>
<span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">API</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">API</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">custom_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">exception_cls</span><span class="p">):</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Oops! Something went wrong. Please, contact our customer support at +1-202-555-0127.&quot;</span>

<span class="n">api</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="n">custom_exception_handler</span><span class="p">)</span>
</pre></div><p>Here we create a custom exception handler. It looks almost like our simple request handlers, except that it has <code>exception_cls</code> as its third argument. Now, if we have a request handler that throws an exception, this above-mentioned custom exception handler should be called.</p><div class="highlight"><pre><span></span><span class="c1"># app.py</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/home&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">exception_throwing_handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;This handler should not be user&quot;</span><span class="p">)</span>
</pre></div><p>If we go to <code>http://localhost:8000/home</code>, instead of our previous big ugly <code>Internal Server Error</code>, we should be able to see our custom message of <code>Oops! Something went wrong. Please, contact our customer support at +1-202-555-0127.</code>. Does it look good enough? Let's go ahead and implement it.</p><p>The first thing we need is a variable inside our main API class where we will store our exception handler:</p><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templates_dir</span><span class="o">=</span><span class="s2">&quot;templates&quot;</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception_handler</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div><p>Now we need to add the <code>add_exception_handler</code> method:</p><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">add_exception_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception_handler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception_handler</span> <span class="o">=</span> <span class="n">exception_handler</span>
</pre></div><p>Having registered our custom exception handler, we need to call when an exception happens. Where do exceptions happen? That's right: when handlers are called. We call the handlers inside our <code>handle_request</code> method. So, we need to wrap it with a try/except clause and call our custom exception handler in the <code>except</code> part:</p><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>

        <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_handler</span><span class="p">(</span><span class="n">request_path</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
                    <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Method now allowed&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>

                <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception_handler</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>
</pre></div><p>We also need to make sure that if no exception handler has been registered, the exception is propagated.</p><p>We have everything in place. Go ahead and restart your gunicorn and go to <code>http://localhost:8000/home</code>. You should see our little cute message instead of the big ugly default one. Of course, make sure that you have the above mentioned exception handler and the errorful request handler in the <code>app.py</code>.</p><p>If you want to go one step further, create a nice template and use our <code>api.template()</code> method inside the exception handler. However, our framework doesn't support static files and thus you will have hard time designing your template with CSS and JavaScript. Don't get sad because this is exactly what we are doing next.</p><h2>Support for static files</h2><p>Templates are not truly templates without good CSS and JavaScript, are they? Shall we add a support for such files then?</p><p>Just like we used Jinja2 for template support, we will use <a href="http://whitenoise.evans.io/en/stable/">WhiteNoise</a> for static file serving. Install it:</p><div class="highlight"><pre><span></span>pip install whitenoise
</pre></div><p>WhiteNoise is pretty simple. The only thing that we need to do is wrap our WSGI app and give it the static folder path as a parameter. Before we do that, let's remember how our <code>__call__</code> method looks like:</p><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

    <span class="o">...</span>
</pre></div><p>This is basically an entrypoint to our WSGI app and this is exactly what we need to wrap with WhiteNoise. Thus, let's refactor its content to a separate method so that it will be easier to wrap it with WhiteNoise:</p><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div><p>Now, in our constructor, we can initialize a WhiteNoise instance:</p><div class="highlight"><pre><span></span><span class="c1"># api.py</span>
<span class="o">...</span>
<span class="kn">from</span> <span class="nn">whitenoise</span> <span class="kn">import</span> <span class="n">WhiteNoise</span>


<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templates_dir</span><span class="o">=</span><span class="s2">&quot;templates&quot;</span><span class="p">,</span> <span class="n">static_dir</span><span class="o">=</span><span class="s2">&quot;static&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templates_env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="n">templates_dir</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception_handler</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whitenoise</span> <span class="o">=</span> <span class="n">WhiteNoise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">static_dir</span><span class="p">)</span>
</pre></div><p>As you can see, we wrapped our <code>wsgi_app</code> with WhiteNoise and gave it a path to the static folder as the second param. The only thing left to do is make this <code>self.whitenoise</code> an entrypoint to our framework:</p><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitenoise</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div><p>With everything in place, create <code>static</code> folder in the project root, create the <code>main.css</code> file inside and put the following into it:</p><div class="highlight"><pre><span></span><span class="nt">body</span> <span class="p">{</span>
    <span class="nb">background-color</span><span class="o">:</span> <span class="nb">chocolate</span><span class="p">;</span>
<span class="p">}</span>
</pre></div><p>In the <a href="/posts/write-python-framework-part-three/">third blog post</a>, we created the <code>templates/index.html</code>. Now we can put our newly created css file inside this template:</p><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">header</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>{{ title }}<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/main.css&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>The name of the framework is {{ name }}<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div><p>Restart your gunicorn and go to <code>http://localhost/template</code>. You should see that the color of the whole background is chocolate, not white, meaning that our static file is being served. Awesome!</p><h2>Middleware</h2><p>If you need a little recap of what middlewares are and how they work, go read <a href="/posts/what-the-hell-is-wsgi-anyway-and-what-do-you-eat-it-with/">this post</a> first. Otherwise, this part may seem a little confusing. I will wait. Back? Great. Let's go.</p><p>You know what they are and how they work but you may be wondering what they are used for. Basically, middleware is a component that can modify an HTTP request and/or response and is designed to be chained together to form a pipeline of behavioral changes during request processing. Examples of middleware tasks can be request logging and HTTP authentication. The main point is that none of these is fully responsible for responding to a client. Instead, each middleware changes the behavior in some way as part of the pipeline, leaving the actual response to come from something later in the pipeline. In our case, that something that actually responds to a client is our request handlers. Middlewares are wrappers around our WSGI app that have the ability to modify requests and responses.</p><p>From the bird's eye view, the code will look like this:</p><div class="highlight"><pre><span></span><span class="n">FirstMiddleware</span><span class="p">(</span><span class="n">SecondMiddleware</span><span class="p">(</span><span class="n">our_wsgi_app</span><span class="p">))</span>
</pre></div><p>So, when a request comes in, it first goes to <code>FirstMiddleware</code>. It modifies the request and sends it over to <code>SecondMiddleware</code>. Now, <code>SecondMiddleware</code> modifies the request and sends it over to <code>our_wsgi_app</code>. Our app handles the request, prepares the response and sends it back to <code>SecondMiddleware</code>. It can modify the response if it wants and send it back to <code>FirstMiddleware</code>. It modifies the response and sends it back to the web server (e.g. gunicorn).</p><p>Let's go ahead and create a <code>Middleware</code> class that other middlewares will inherit from and that wraps our wsgi app.</p><p>Create a <code>middleware.py</code> file first:</p><div class="highlight"><pre><span></span>touch middleware.py
</pre></div><p>Now, we can begin our <code>Middleware class</code>:</p><div class="highlight"><pre><span></span><span class="c1"># middleware.py</span>

<span class="k">class</span> <span class="nc">Middleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
</pre></div><p>As we mentioned above, it should wrap a wsgi app and in case of multiple middlewares that <code>app</code> can also be another middleware.</p><p>As a base middleware class, it should also have the ability to add another middleware to the stack:</p><div class="highlight"><pre><span></span><span class="c1"># middleware.py</span>

<span class="k">class</span> <span class="nc">Middleware</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">middleware_cls</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">middleware_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
</pre></div><p>It is simply wrapping the given middleware class around our current app.</p><p>It should also have its main methods which are request processing and response processing. For now, they will do nothing. The child classes that will inherit from this class will implement these methods:</p><div class="highlight"><pre><span></span><span class="c1"># middleware.py</span>

<span class="k">class</span> <span class="nc">Middleware</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div><p>Now, the most important part, the method that handles incoming requests:</p><div class="highlight"><pre><span></span><span class="c1"># middleware.py</span>

<span class="k">class</span> <span class="nc">Middleware</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>
</pre></div><p>It first calls the <code>self.process_request</code> to do something with the request. Then delegates the response creation to the app that it is wrapping. Finally, it calls the <code>process_response</code> to do something with the response object. Then simply returns the response upward.</p><p>As middlewares are the first entrypoint to our app now, they are the ones called by our web server (e.g. gunicorn). Thus, middlewares should implement the WSGI entrypoint interface:</p><div class="highlight"><pre><span></span><span class="c1"># middleware.py</span>

<span class="k">class</span> <span class="nc">Middleware</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div><p>It is just a copy of the <code>wsgi_app</code> function we created above.</p><p>With our Middleware class implemented, let's add it to our main <code>API</code> class:</p><div class="highlight"><pre><span></span><span class="c1"># api.py</span>
<span class="kn">from</span> <span class="nn">middleware</span> <span class="kn">import</span> <span class="n">Middleware</span>


<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span> <span class="o">=</span> <span class="n">Middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div><p>It wraps around <code>self</code> which is our wsgi app. Now, let's give it the ability to add middlewares:</p><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">add_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">middleware_cls</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">middleware_cls</span><span class="p">)</span>
</pre></div><p>The only thing left to do is call this middleware in the entrypoint instead of our own wsgi app:</p><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div><p>Why do you ask? Because we are delegating the job of being an entrypoint to the middlewares now. Remember that we implemented WSGI entrypoint interface inside our <code>Middleware</code> class. Let's go ahead now and create a simple middleware that simply prints to the console:</p><div class="highlight"><pre><span></span><span class="c1"># app.py</span>
<span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">API</span>
<span class="kn">from</span> <span class="nn">middleware</span> <span class="kn">import</span> <span class="n">Middleware</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">API</span><span class="p">()</span>

<span class="o">...</span>

<span class="k">class</span> <span class="nc">SimpleCustomMiddleware</span><span class="p">(</span><span class="n">Middleware</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Processing request&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Processing response&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">SimpleCustomMiddleware</span><span class="p">)</span>

<span class="o">...</span>
</pre></div><p>Restart your gunicorn and go to any url (e.g. <code>http://localhost:8000/home</code>). Everything should work just like before. The only exception is that those texts should appear in the console. Open your console and you should see the following:</p><div class="highlight"><pre><span></span>Processing request http://localhost:8000/home
Processing response http://localhost:8000/home
</pre></div><p>There is a catch. Have you found it? Static files don't work now. The reason is that we stopped using <code>WhiteNoise</code>. We removed it. Instead of calling <code>WhiteNoise</code>, we are calling the middleware. Here is what we should do. We need to distinguish between requests for static files and the others. When a request is coming in for a static file, we should call <code>WhiteNoise</code>. For others, we should call the middleware. The question is how do we distinguish between them. Right now, requests for static files look like this: <code>http://localhost:8000/main.css</code>. Other requests look like this <code>http://localhost:8000/home</code>. They look the same for our <code>API</code> class. Thus we will add a root to the URLs of static files so that they look like this <code>http://localhost:8000/static/main.css</code>. We will check if the request path starts with <code>/static</code>. If so, we will call <code>WhiteNoise</code>, otherwise we will call the middleware. We should also make sure to cut the <code>/static</code> part. Otherwise <code>WhiteNoise</code> won't find the files:</p><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">path_info</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">path_info</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/static&quot;</span><span class="p">):</span>
            <span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_info</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;/static&quot;</span><span class="p">):]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitenoise</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div><p>Restart your gunicorn and check that everything is working properly.</p><p>We will use this middleware feature in the future posts to add authentication to our apps.</p><p>I think that this middleware part is more difficult to understand compared to others. I also think that I didn't do a great job explaining it. Thus, please write the code, let it sink in and ask me questions in the comments if something is not clear.</p><p><em>Check out Part I <a href="/posts/write-python-framework-part-one/">here</a></em><br><em>Check out Part II <a href="/posts/write-python-framework-part-two/">here</a></em><br><em>Check out Part III <a href="/posts/write-python-framework-part-three/">here</a></em></p><blockquote><p>A little reminder that this series is based on the <a href="https://github.com/rahmonov/alcazar">Alcazar framework</a> that I am writing for learning purposes. If you liked this series, show some love by starring the <a href="https://github.com/rahmonov/alcazar">repo</a>.</p></blockquote><p>That's it from me today.</p><p>Fight on!</p></div><div class="pagination clearfix"><a class="prev" href="/posts/write-python-framework-part-three/">« Previous</a></ul></div><p><div class="likely likely-big"><div class="facebook">Share</div><div class="twitter" data-via="rahmon0v">Tweet</div><div class="telegram">Send</div><div class="linkedin">Share</div></div></p><div class="end"><span> If you liked what you read, subscribe below. Once in a while, I will send you a list of my new posts. </span><div id="popup"><p><link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css"><style type="text/css">
                #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
                /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
            </style><div id="mc_embed_signup"><form action="//rahmonov.us16.list-manage.com/subscribe/post?u=9e30bdfdfe0a7bd7cf7e0d50a&id=af3f3c5f76" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate><div id="mc_embed_signup_scroll"><div class="indicates-required"><span class="asterisk">*</span> indicates required</div><div class="mc-field-group"><label for="mce-MMERGE1">Name </label><input type="text" value name="MMERGE1" class id="mce-MMERGE1"></div><div class="mc-field-group"><label for="mce-EMAIL">Email Address <span class="asterisk">*</span></label><input type="email" value name="EMAIL" class="required email" id="mce-EMAIL"></div><div id="mce-responses" class="clear"><div class="response" id="mce-error-response" style="display:none"></div><div class="response" id="mce-success-response" style="display:none"></div></div> <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9e30bdfdfe0a7bd7cf7e0d50a_af3f3c5f76" tabindex="-1" value></div><div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div></div></form></div></p></div></div><div id="disqus_thread"></div><script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'jrahmonov';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div><script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67392250-1', 'auto');
      ga('send', 'pageview');
    </script><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script><script src="/static/js/mobile.js"></script><script src="/static/vendor/lightbox2/js/lightbox.min.js"></script><script src="/static/"></script></body></html>