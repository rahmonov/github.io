<!DOCTYPE html><html lang="en"><head prefix="og: http://ogp.me/ns#"><title>Introduction to Python Social Auth</title><link rel="stylesheet" href="/static/css/main.css"><link rel="stylesheet" href="/static/css/pygment.css"><link rel="stylesheet" href="/static/css/font-awesome.min.css"><link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/static/vendor/lightbox2/css/lightbox.min.css"><link href="https://afeld.github.io/emoji-css/emoji.css" rel="stylesheet"><link rel="shortcut icon" type="image/png" href="/static/images/favicon.png"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="<p>Python Social Auth aims to be an easy to setup social authentication and authorization mechanism for Python projects</p>"><meta name="author" content="Jahongir Rahmonov"><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"><meta property="og:title" content="Introduction to Python Social Auth"><meta property="og:type" content="website"><meta property="og:image" content="/static/images/programming.jpg"><meta property="og:url" content="http://rahmonov.me/posts/introduction-to-python-social-auth/"><meta property="og:description" content="<p>Python Social Auth aims to be an easy to setup social authentication and authorization mechanism for Python projects</p>"><link href="http://rahmonov.me/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Full Atom Feed"><link href="http://rahmonov.me/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Jahongir Rahmonov Full RSS Feed"><link href="http://rahmonov.me/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Categories Atom Feed"><meta name="description" content="<p>Python Social Auth aims to be an easy to setup social authentication and authorization mechanism for Python projects</p>"><meta name="tags" content="python"><meta name="tags" content="authentication"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-7110437178205620",
            enable_page_level_ads: true
       });
  </script><link href="https://unpkg.com/ilyabirman-likely@2/release/likely.css" rel="stylesheet"><script src="https://unpkg.com/ilyabirman-likely@2/release/likely.js" type="text/javascript"></script></head><body id="index" class="home"><div class="container"><button class="nav js-mobile"><i class="fa fa-bars"></i></button><div class="side"><div class="logo"><a href="/"><img src="/static/images/me.jpg" width="150px" height="150px" class="jahon" alt="Jahongir Rahmonov"></a></div><h2>Jahongir Rahmonov</h2><div class="paragraphs"><p> I'm a Software Developer at <a href="http://mysuperdispatch.com/">Super Dispatch (TechStars '16)</a>. Avid reader. <a href="http://wiut.uz/">WIUT</a> graduate. Blogger and an amateur speaker </p><p> I write about Python, Django, AngularJS and sometimes something non-technical. </p><p> Welcome to my corner <i class="em em-snake"></i></p> </div><form method="get" action="https://www.google.com/search"><input name="sitesearch" value="rahmonov.me" type="hidden"><input type="text" id="search-query" class="field field-text" required name="q" placeholder="Search..." autocomplete="off"><input type="image" src="/static/images/search-icon.png" width="20" height="20" class="search-icon" title="Search via Google" alt="Search via Google"></form><ul class="menu"><li><a href="/">Home</a></li><li><a href="/pages/about.html">About</a></li><li><a href="/pages/about.html#subscribe">Subscribe</a></li><li><a href="/pages/about.html#contact">Contact</a></li><li><a href="/feeds/atom.xml">RSS <i class="fa fa-rss"></i></a></li></ul><p class="profiles"><a title="GitHub" href="https://github.com/rahmonov"><i class="fa fa-github-square"></i></a><a title="StackOverflow" href="https://stackoverflow.com/users/4137194/jahongir-rahmonov?tab=profile"><i class="fa fa-stack-overflow"></i></a><a title="Twitter" href="https://twitter.com/the_rahmonov"><i class="fa fa-twitter-square"></i></a><a title="Facebook" href="https://www.facebook.com/rahmonovj"><i class="fa fa-facebook-official"></i></a><a title="Instagram" href="https://www.instagram.com/rahmonov.me/"><i class="fa fa-instagram"></i></a><a title="LinkedIn" href="https://www.linkedin.com/in/jahongirrahmonov"><i class="fa fa-linkedin-square"></i></a></p><br><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7110437178205620" data-ad-slot="4214071905" data-ad-format="auto"></ins><script>
              (adsbygoogle = window.adsbygoogle || []).push({});
              </script></div><div class="wrap"><div class="content"><h4>Sat 12 September 2015</h4><h1>Introduction to Python Social Auth</h1><div class="entry-content"><p>Python Social Auth aims to be an easy to setup social authentication and authorization mechanism for Python projects supporting protocols like OAuth (1 and 2), OpenId and others.</p><p>Written by <a href="https://github.com/omab">omab</a>, this library helps a great deal in integrating social authentication to your web apps. Why am I writing this when there is a whole <a href="http://psa.matiasaguirre.net/docs/index.html">documentation</a> on the subject? This post is by no means intended to replace the documentation. It is intended to serve as an introduction to the library itself and concepts used in it, such as pipeline, partial pipeline, extending and etc. understanding of which would have saved me a lot of time when I was learning the library.</p><p>I will not talk about small things like installation and configuration but rather try to give you a bigger picture on PSA.</p><h2>Pipeline</h2><p>PSA uses a mechanism called Pipeline to do the autentication. Pipeline is like a stack of functions. These functions get executed one by one and return some result to the next function. The default pipeline looks like this:</p><div class="highlight"><pre><span></span><span class="n">SOCIAL_AUTH_PIPELINE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;social.pipeline.social_auth.social_details&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.social_uid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.auth_allowed&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.social_user&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.user.get_username&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;social.pipeline.mail.mail_validation&#39;,</span>
    <span class="c1"># &#39;social.pipeline.social_auth.associate_by_email&#39;,</span>
    <span class="s1">&#39;social.pipeline.user.create_user&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.associate_user&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.load_extra_data&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.user.user_details&#39;</span>
<span class="p">)</span>
</pre></div><p>This is what happens when a user clicks a login button: <code>social_details</code> function gets executed first. It gets the information it can from, let's say, Facebook and returns it to the method <code>social_uid</code> in a simple format. <code>social_uid</code> method does the same thing: does something with the information it got from <code>social_details</code> and returns the result to <code>auth_allowed</code>. So on and so forth until the end of the pipeline when user gets returned to the url you specified. This is the authentication pipeline. There is also an disconnection pipeline, i.e. pipeline for when a user logs out. The same principles apply to that too. More info on pipeline can be found <a href="http://psa.matiasaguirre.net/docs/pipeline.html">here</a>.</p><p>Now, you can do whatever you like with this set of functions for the pipeline and customize it however you like. You can remove any of the methods, for example to create a pipeline that won't create users, just accepts already registered ones:</p><div class="highlight"><pre><span></span><span class="n">SOCIAL_AUTH_PIPELINE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;social.pipeline.social_auth.social_details&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.social_uid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.auth_allowed&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.social_user&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.associate_user&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.load_extra_data&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.user.user_details&#39;</span>
<span class="p">)</span>
</pre></div><p>Customize any of the methods:</p><div class="highlight"><pre><span></span><span class="n">SOCIAL_AUTH_PIPELINE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;path.to.custom.social_details&#39;</span><span class="p">,</span>    <span class="c1"># custom method</span>
    <span class="s1">&#39;social.pipeline.social_auth.social_uid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.auth_allowed&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.social_user&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.associate_user&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.social_auth.load_extra_data&#39;</span><span class="p">,</span>
    <span class="s1">&#39;social.pipeline.user.user_details&#39;</span>
<span class="p">)</span>
</pre></div><p>or just create a function and add it to the pipeline. Good example of extending a pipeline can be found <a href="http://psa.matiasaguirre.net/docs/pipeline.html#extending-the-pipeline">here</a>.</p><h2>Partial Pipeline</h2><p>It is also possible to cut the pipeline to ask the user for more information and resume the proccess later. For example, to ensure that the user provides his email, you can write the following partial pipeline:</p><div class="highlight"><pre><span></span><span class="nd">@partial</span>
<span class="k">def</span> <span class="nf">require_email</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">is_new</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="n">is_new</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">):</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">request_data</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">email</span><span class="p">:</span>
            <span class="n">details</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;require_email&#39;</span><span class="p">)</span>
</pre></div><p>This method first checks whether email exists. If so, continues the pipeline. Otherwise, it will redirect to <code>require_email</code> view, which looks like this:</p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">require_email</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;path/to/template.html&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</pre></div><p>So, it will render the template with a form. Attention: this form must be submitted to <code>/complete/&lt;backend&gt;/</code> to continue the pipeline:</p><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/complete/instagram&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
</pre></div><p>After a user submits the form, the pipeline comes to this part of the partial pipeline code:</p><div class="highlight"><pre><span></span><span class="n">email</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">request_data</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">email</span><span class="p">:</span>
    <span class="n">details</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>  
</pre></div><p>and if user entered his email, the pipeline continues and you will have access to his email through <code>details['email']</code>.</p><h2>Important use case</h2><p>Provide login/registration with PSA for two types of users.</p><p>So we have two types of users, SimpleUser and Shop(SimpleUser) which extends from SimpleUser. To provide different registration proccess for them we can do the following:</p><ol><li><p>Provide two different links and mark one of them with a get parameter(user_type):</p><div class="highlight"><pre><span></span><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{% url &#39;social:begin&#39; &#39;facebook&#39; %}&quot;</span><span class="nt">&gt;</span>Login as SimpleUser<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{% url &#39;social:begin&#39; &#39;facebook&#39; %}?user_type=shop&quot;</span><span class="nt">&gt;</span>Login as Shop<span class="nt">&lt;/a&gt;</span>
</pre></div></li><li><p>In order to access this get parameter, we will have to do this in our settings file:</p><div class="highlight"><pre><span></span>FIELDS_STORED_IN_SESSION = [&#39;user_type&#39;]
</pre></div><p>This will ensure that the value of this paramter is saved in a session.</p></li><li><p>Then in <code>create_user</code> method of the pipeline, create different users depending on this parameter:</p><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">user_type</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">session_get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user_type</span> <span class="o">==</span> <span class="s1">&#39;shop&#39;</span><span class="p">:</span>
          <span class="c1"># create a shop</span>
    <span class="k">else</span><span class="p">:</span>
          <span class="c1"># create a simple user</span>
</pre></div><p>and don't forget to include it in the pipeline settings.</p></li><li><p>We are done! Hooorrayy =)</p></li></ol><p>Okay fellas, I hope you now have at least a little idea about how things work in PSA and can easily read the documentation. These were only the most important and basic parts. Checkout the documentation for the details. </p><p>Fight on!</p></div><div class="pagination clearfix"><a class="prev" href="/posts/why-one-plus-one-is-not-two/">« Previous</a><a class="next" href="/posts/django-1.8-bug/">Next »</a></ul></div><p><div class="likely likely-big"><div class="facebook">Share</div><div class="twitter" data-via="rahmon0v">Tweet</div><div class="telegram">Send</div><div class="linkedin">Share</div></div></p><div class="end"><span> If you liked what you read, subscribe below. Once in a while, I will send you a list of my new posts. </span><div id="popup"><p><link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css"><style type="text/css">
                #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
                /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
            </style><div id="mc_embed_signup"><form action="//rahmonov.us16.list-manage.com/subscribe/post?u=9e30bdfdfe0a7bd7cf7e0d50a&id=af3f3c5f76" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate><div id="mc_embed_signup_scroll"><div class="indicates-required"><span class="asterisk">*</span> indicates required</div><div class="mc-field-group"><label for="mce-MMERGE1">Name </label><input type="text" value name="MMERGE1" class id="mce-MMERGE1"></div><div class="mc-field-group"><label for="mce-EMAIL">Email Address <span class="asterisk">*</span></label><input type="email" value name="EMAIL" class="required email" id="mce-EMAIL"></div><div id="mce-responses" class="clear"><div class="response" id="mce-error-response" style="display:none"></div><div class="response" id="mce-success-response" style="display:none"></div></div> <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9e30bdfdfe0a7bd7cf7e0d50a_af3f3c5f76" tabindex="-1" value></div><div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div></div></form></div></p></div></div> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7110437178205620" data-ad-slot="4409204211" data-ad-format="auto"></ins><script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script><div id="disqus_thread"></div><script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'jrahmonov';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div><script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67392250-1', 'auto');
      ga('send', 'pageview');
    </script><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script><script src="/static/js/mobile.js"></script><script src="/static/vendor/lightbox2/js/lightbox.min.js"></script></body></html>