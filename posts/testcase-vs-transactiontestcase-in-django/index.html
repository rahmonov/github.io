<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
          <title> TestCase vs TransactionTestCase in Django </title>

        <link rel="stylesheet" href="/static/css/main.css" />
        <link rel="stylesheet" href="/static/css/pygment.css" />
        <link rel="stylesheet" href="/static/css/font-awesome.min.css" />
        <link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="/static/vendor/lightbox2/css/lightbox.min.css">
        <link href="https://afeld.github.io/emoji-css/emoji.css" rel="stylesheet">

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="<p>The difference between TestCase and TransactionTestCase in Django</p>" />
        <meta name="author" content="Jahongir Rahmonov" />
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

<meta property="og:title" content="TestCase vs TransactionTestCase in Django">
<meta property="og:type" content="website">
<meta property="og:image" content="/static/images/programming.jpg">
<meta property="og:url" content="http://rahmonov.me/posts/testcase-vs-transactiontestcase-in-django/">
<meta property="og:description" content="<p>The difference between TestCase and TransactionTestCase in Django</p>">

        <link href="http://rahmonov.me/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Full Atom Feed" />
        <link href="http://rahmonov.me/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Jahongir Rahmonov Full RSS Feed" />
        <link href="http://rahmonov.me/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Categories Atom Feed" />


        <meta name="description" content="<p>The difference between TestCase and TransactionTestCase in Django</p>" />

    <meta name="tags" content="python" />
    <meta name="tags" content="django" />
    <meta name="tags" content="unittesting" />
    <meta name="tags" content="testing" />

</head>

<body id="index" class="home">
    <div class="container">

        <button class="nav js-mobile">
            <i class="fa fa-bars"></i>
        </button>

        <div class="side">
            <div class="logo">
                <a href="/"><img src="/static/images/me.jpg" class="jahon" alt="Jahongir Rahmonov"/></a>
            </div>

            <h2>Jahongir Rahmonov</h2>

            <div class="paragraphs">
<p>
    I'm a Software Developer at <a href="http://mysuperdispatch.com/">Super Dispatch (TechStars '16)</a>.
    Avid reader.
    <a href="http://wiut.uz/">WIUT</a> graduate.
    Blogger and an amateur speaker
</p>
<p>
    I write about Python, Django, AngularJS and sometimes something non-technical.
</p>
<p>
    Welcome to my corner <i class="em em-snake"></i>
</p>            </div>

            <form method="get" action="https://www.google.com/search">
                <input name="sitesearch" value="rahmonov.me" type="hidden">
                <input type="text" id="search-query" class="field field-text" required="required" name="q" placeholder="Search..." autocomplete="off">
                <input type="image" src="/static/images/search-icon.png" width="20" height="20" class="search-icon" title="Search via Google" alt="Search via Google">
            </form>

            <ul class="menu">
                <li><a href="/">Home</a></li>
                <li><a href="/pages/about.html">About</a></li>
                <li><a href="/pages/about.html#subscribe">Subscribe</a></li>
                <li><a href="/pages/about.html#contact">Contact</a></li>
                <li><a href="/feeds/atom.xml" target="_blank">RSS <i class="fa fa-rss"></i></a></li>
            </ul>

            <p class="profiles">
                <a title="GitHub" href="https://github.com/rahmonov" target="_blank"><i class="fa fa-github-square"></i></a>
                <a title="StackOverflow" href="https://stackoverflow.com/users/4137194/jahongir-rahmonov?tab=profile" target="_blank"><i class="fa fa-stack-overflow"></i></a>
                <a title="Twitter" href="https://twitter.com/the_rahmonov" target="_blank"><i class="fa fa-twitter-square"></i></a>
                <a title="Facebook" href="https://www.facebook.com/rahmonovj" target="_blank"><i class="fa fa-facebook-official"></i></a>
                <a title="Bitbucket" href="https://bitbucket.org/Jahongir/" target="_blank"><i class="fa fa-bitbucket-square"></i></a>
                <a title="LinkedIn" href="https://www.linkedin.com/in/jahongirrahmonov" target="_blank"><i class="fa fa-linkedin-square"></i></a>
            </p>

              <br>
              <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
              <!-- sidebar-ad -->
              <ins class="adsbygoogle"
                   style="display:block"
                   data-ad-client="ca-pub-7110437178205620"
                   data-ad-slot="4214071905"
                   data-ad-format="auto"></ins>
              <script>
              (adsbygoogle = window.adsbygoogle || []).push({});
              </script>
        </div>

        <div class="wrap">
            <div class="content">

  <h4>Sun 11 June 2017</h4>

  <h1>TestCase vs TransactionTestCase in Django</h1>

  <div class="entry-content">
    <p>Based on my observation, a lot of developers don't seem to understand the difference between <code>TestCase</code> and <code>TransactionTestCase</code>
in Django and how to use them. In this post, I will try to put the puzzle pieces together and make things clear.</p>
<h2>TestCase class</h2>
<p>Here is what <a href="https://docs.djangoproject.com/en/1.11/topics/testing/tools/#django.test.TestCase">the documentation</a> has to say
about the <code>TestCase</code> class:</p>
<blockquote>
<p>Wraps the tests within two nested atomic() blocks: one for the whole class and one for each test.</p>
</blockquote>
<p>Now imagine that you have a method that must be executed inside a transaction or else it raises an error. You could write a test similar to this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SomeTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_your_method_raises_error_without_atomic_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">SomeError</span><span class="p">):</span>
            <span class="n">your_method</span><span class="p">()</span>
</pre></div>


<p>In this test, <code>your_method()</code> is called without any transaction and the test is asserting that it raises <code>SomeError</code> because of that.</p>
<p>However, this test will unexpectedly fail! The reason is, you guessed it, TestCase wraps the tests with <code>atomic()</code> blocks 
ALL THE TIME. Thus, <code>your_method()</code> will not raise an error, which is why this test will fail.</p>
<h2>TransactionTestCase to the rescue</h2>
<p>This is where <code>TransactionTestCase</code> should be used. It does not wrap the tests with <code>atomic()</code> block and thus you can test your special 
methods that require a transaction without any problem. The above test will pass with <code>TransactionTestCase</code> now:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SomeTestCase</span><span class="p">(</span><span class="n">TransactionTestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_your_method_raises_error_without_atomic_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">SomeError</span><span class="p">):</span>
            <span class="n">your_method</span><span class="p">()</span>
</pre></div>


<h2>Real Life example</h2>
<p>Let's see a real example now. A queryset method called <a href="https://docs.djangoproject.com/en/1.11/ref/models/querysets/#django.db.models.query.QuerySet.select_for_update">select_for_update()</a> 
is one of those methods that require to be inside a transaction. If you call it without any transaction, it raises an error.</p>
<p>Let's say you have a model called <code>Item</code> and you are calling <code>select_for_update()</code>:</p>
<div class="highlight"><pre><span></span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_for_update</span><span class="p">()</span>
</pre></div>


<p>It will immediately raise the following error:</p>
<div class="highlight"><pre><span></span><span class="n">TransactionManagementError</span><span class="o">:</span> <span class="n">select_for_update</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">used</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">a</span> <span class="n">transaction</span><span class="o">.</span>
</pre></div>


<p>Now, let's try to write tests for it with both <code>TestCase</code> and <code>TransactionTestCase</code>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ItemTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;hat&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_select_for_update_raises_an_error_without_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">TransactionManagementError</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">Items</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_for_update</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>  <span class="c1"># needed to actually execute the query because they are lazy</span>
</pre></div>


<p>Try to run the test and you will get the following:</p>
<div class="highlight"><pre><span></span>AssertionError: TransactionManagementError not raised
</pre></div>


<p>The reason? <code>TestCase</code> wraps the tests with <code>atomic()</code> blocks ALL THE TIME. Good. Glad you remember this. </p>
<p>Now, let's make this test pass with <code>TransactionTestCase</code>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ItemTestCase</span><span class="p">(</span><span class="n">TransactionTestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;hat&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_select_for_update_raises_an_error_without_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">TransactionManagementError</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">Items</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_for_update</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>  <span class="c1"># needed to actually execute the query because they are lazy</span>
</pre></div>


<p>and voila! The test passes! Great!</p>
<p>I hope it will clear things out for some people. Let me know in the comments if something is still not clear.</p>
<p>Fight on!</p>
  </div>

  <div class="pagination clearfix">
         <a class="prev" href="/posts/continuous-integration-and-continous-deployment-for-django-app-with-jenkins/">« Previous</a>
         <a class="next" href="/posts/python-collections-counter/">Next »</a>
    </ul>
  </div>

<div class="end">
    <span>
        If you liked what you read, subscribe below. Once in a while, I will send you a list of my new posts.
    </span>

    <div id="popup">
        <p>
            <!-- Begin MailChimp Signup Form -->
            <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
            <style type="text/css">
                #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
                /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
            </style>
            <div id="mc_embed_signup">
            <form action="//rahmonov.us16.list-manage.com/subscribe/post?u=9e30bdfdfe0a7bd7cf7e0d50a&amp;id=af3f3c5f76" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
                <div id="mc_embed_signup_scroll">
            <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
            <div class="mc-field-group">
                <label for="mce-MMERGE1">Name </label>
                <input type="text" value="" name="MMERGE1" class="" id="mce-MMERGE1">
            </div>
            <div class="mc-field-group">
                <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
            </label>
                <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
            </div>
                <div id="mce-responses" class="clear">
                    <div class="response" id="mce-error-response" style="display:none"></div>
                    <div class="response" id="mce-success-response" style="display:none"></div>
                </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9e30bdfdfe0a7bd7cf7e0d50a_af3f3c5f76" tabindex="-1" value=""></div>
                <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
                </div>
            </form>
            </div>
            <!--End mc_embed_signup-->
        </p>
    </div>
</div>    <div style="text-align: center">
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <!-- above-comments -->
        <ins class="adsbygoogle"
             style="display:inline-block;width:728px;height:90px"
             data-ad-client="ca-pub-7110437178205620"
             data-ad-slot="6262754395"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'jrahmonov';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
        </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67392250-1', 'auto');
      ga('send', 'pageview');
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="/static/js/mobile.js"></script>
    <script src="/static/vendor/lightbox2/js/lightbox.min.js"></script>
</body>
</html>