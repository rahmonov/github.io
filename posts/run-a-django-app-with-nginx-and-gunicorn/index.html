<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
          <title> Run a Django app with Nginx and Gunicorn in Ubuntu 16.04 (Part II) - Jahongir Rahmonov </title>

        <link rel="stylesheet" href="/static/css/main.css" />
        <link rel="stylesheet" href="/static/css/pygment.css" />
        <link rel="stylesheet" href="/static/css/font-awesome.min.css" />
        <link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Jahongir Rahmonov's personal blog" />
        <meta name="author" content="Jahongir Rahmonov" />
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

<meta property="og:title" content="Run a Django app with Nginx and Gunicorn in Ubuntu 16.04 (Part II) - Jahongir Rahmonov">
<meta property="og:type" content="website">
<meta property="og:image" content="/static/images/programming.jpg">
<meta property="og:url" content="http://rahmonov.github.io/posts/run-a-django-app-with-nginx-and-gunicorn/">
<meta property="og:description" content="<p>How to run a Django app with Nginx and Gunicorn</p>">

        <link href="http://rahmonov.github.io/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Full Atom Feed" />
        <link href="http://rahmonov.github.io/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Jahongir Rahmonov Full RSS Feed" />
        <link href="http://rahmonov.github.io/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Jahongir Rahmonov Categories Atom Feed" />



    <meta name="tags" content="python" />
    <meta name="tags" content="django" />
    <meta name="tags" content="gunicorn" />
    <meta name="tags" content="nginx" />

</head>

<body id="index" class="home">
    <div class="container">

        <button class="nav js-mobile">
            <i class="fa fa-bars"></i>
        </button>

        <div class="side">
            <div class="logo">
                <a href="/"><img src="/static/images/me.jpg" class="jahon" alt="Jahongir Rahmonov"/></a>
            </div>

            <h2>Jahongir Rahmonov</h2>

            <div class="paragraphs">
<p>
    I hold a BSc hon. in Business Information Systems from <a href="http://wiut.uz/">WIUT</a>.
    I'm currently a Software Developer at <a href="http://mysuperdispatch.com/">Super Dispatch (TechStars '16)</a>
</p>
<p>
    I write about web, books, productivity and other things that are of interest to me.
</p>            </div>

            <form method="get" action="https://www.google.com/search">
                <input name="sitesearch" value="rahmonov.me" type="hidden">
                <input type="text" id="search-query" class="field field-text" required="required" name="q" placeholder="Search..." autocomplete="off">
                <input type="image" src="/static/images/search-icon.png" width="20" height="20" class="search-icon" title="Search via Google" alt="Search via Google">
            </form>

            <ul class="menu">
                <li><a href="/">Home</a></li>
                <li><a href="/pages/posts.html">Posts</a></li>
                <li><a href="/pages/about.html">About</a></li>
                <li><a href="/pages/about.html#contact">Contact</a></li>
                <li><a href="/feeds/atom.xml" target="_blank">RSS <i class="fa fa-rss"></i></a></li>
            </ul>

            <p class="profiles">
                <a title="GitHub" href="https://github.com/rahmonov" target="_blank"><i class="fa fa-github-square"></i></a>
                <a title="Twitter" href="https://twitter.com/the_rahmonov" target="_blank"><i class="fa fa-twitter-square"></i></a>
                <a title="Facebook" href="https://www.facebook.com/rahmonovj" target="_blank"><i class="fa fa-facebook-official"></i></a>
                <a title="Bitbucket" href="https://bitbucket.org/Jahongir/" target="_blank"><i class="fa fa-bitbucket-square"></i></a>
                <a title="LinkedIn" href="https://www.linkedin.com/in/jahongirrahmonov" target="_blank"><i class="fa fa-linkedin-square"></i></a>
            </p>
        </div>

        <div class="wrap">
            <div class="content">

  <h4>Sun 26 February 2017</h4>

  <h1>Run a Django app with Nginx and Gunicorn in Ubuntu 16.04 (Part II)</h1>

  <div class="entry-content">
    <p>This tutorial is the continuation of <a href="http://rahmonov.me/posts/run-a-django-app-with-gunicorn-in-ubuntu-16-04/">this one</a> where we learned
how to run a django app with gunicorn. Now we will add Nginx into the mix.</p>
<h2>The reason we need Nginx</h2>
<p>If you followed the previous tutorial, we ran our django app with Gunicorn. However, at the end, we saw that the styles of the admin
panel were gone. The reason is that Gunicorn is an application server and just runs the app (django app in our case) and django, as we know,
does not serve static files except in development. Nginx to the rescue! It will be a reverse proxy for Gunicorn. What the hell is a reverse proxy?
Good question! We all know what VPNs are, right? We use them to access some website that is blocked for some reason. In this case, we access
that website through a VPN: We -&gt; VPN -&gt; some website. This kind of proxies are called Forward Proxies. As for reverse proxies, think of
them as forced proxies. For example, a user is trying to access our django app running in gunicorn. He thinks that he is accessing the app directly.
However, what is happening is that he is first accessing the Nginx server which decides what to do next. If the user is accessing a static file,
the Nginx server will serve it itself. Otherwise, it will redirect it to Gunicorn. In plain terms, http requests will be handled by
Gunicorn and static ones by Nginx. That's why we need Nginx.</p>
<p>Apart from that, Nginx also improves performance, reliability, security and scale.</p>
<h2>Installation</h2>
<p>By now we already have Django and Gunicorn ready. So, let's install Nginx now:</p>
<div class="highlight"><pre><span></span>sudo apt-get install nginx
</pre></div>


<p>Now, we will configure Nginx to pass traffic to the process.</p>
<p>Create a file <code>/etc/nginx/sites-available/djtrump</code> and type in the following:</p>
<div class="highlight"><pre><span></span>server <span class="o">{</span>
    listen 8000<span class="p">;</span>
    server_name 0.0.0.0<span class="p">;</span>

    <span class="nv">location</span> <span class="o">=</span> /favicon.ico <span class="o">{</span> access_log off<span class="p">;</span> log_not_found off<span class="p">;</span> <span class="o">}</span>

    location /static/ <span class="o">{</span>
            root /home/ubuntu/myproject<span class="p">;</span>
    <span class="o">}</span>

    location / <span class="o">{</span>
            include proxy_params<span class="p">;</span>
            proxy_pass http://unix:/home/ubuntu/myproject/myproject.sock<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Adjust the paths such as <code>/home/ubuntu/myproject</code> to your own environment.</p>
<p>Let's see what is going on here.</p>
<p>The first two lines tell that it will listen to the port <code>8000</code> on <code>0.0.0.0</code>. The next line about favicon will tell Nginx to ignore
problems with favicon.ico.</p>
<p>The next block is very important. It says that static files, which all have a standard URI prefix of <code>static/</code> should be looked for in
<code>~/myproject/static/</code> folder.</p>
<p>And the last location block matches all other requests other that static ones (remember reverse proxy). One thing to note here is that Nginx and Gunicorn "talk to" 
each other through a unix socket. That's why we will bind our gunicorn to a socket as we will see soon.</p>
<p>Now, let's enable this file by linking it to the <code>sites-enabled</code> folder:</p>
<div class="highlight"><pre><span></span>sudo ln -s /etc/nginx/sites-available/myproject /etc/nginx/sites-enabled
</pre></div>


<p>and check if our configuration file was correctly written:</p>
<div class="highlight"><pre><span></span>sudo nginx -t
</pre></div>


<p>If everything is OK, you should see something like this:</p>
<div class="highlight"><pre><span></span>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf <span class="nb">test</span> is successful
</pre></div>


<p>You may ask what all that linking and <code>sites-enabled</code> folder were about. We could have included those settings in Nginx's main settings file:
<code>/etc/nginx/nginx.conf</code>. If we take a look at it, we will see this:</p>
<div class="highlight"><pre><span></span>include /etc/nginx/sites-enabled/*
</pre></div>


<p>So, we can see that what we did makes it more modular and much easier to maintain when we have several apps being served by Nginx.</p>
<p>OK, now that we have configured Nginx, let's see some action.</p>
<p>First, let's move all our static files to <code>~/myproject/static/</code> because we set up Nginx to look for them there.
Open up <code>myproject/settings.py</code> and add this:</p>
<div class="highlight"><pre><span></span><span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;static/&#39;</span><span class="p">)</span>
</pre></div>


<p>Save and close. Now, let's collect them to that folder:</p>
<div class="highlight"><pre><span></span>./manage.py collectstatic
</pre></div>


<p>Confirm the operation and our static files should be there for Nginx to find them.</p>
<p>Now, let's finally run our app:</p>
<div class="highlight"><pre><span></span>gunicorn --daemon --workers <span class="m">3</span> --bind unix:/home/ubuntu/myproject/myproject.sock myproject.wsgi
</pre></div>


<p>As I told earlier, we are starting gunicorn a little differently now. We are binding it to a unix socket file which is needed to talk
to Nginx. This file will be created and enable Nginx and Gunicorn to talk to each other. You may ask what about ports and ip?.
Nginx will take care of that. Remember we configured it to listen to <code>0.0.0.0:8000</code>? Cool! Now, let's restart Nginx to make these changes
take effect.</p>
<div class="highlight"><pre><span></span>sudo service nginx restart
</pre></div>


<p>Now, go ahead and access <code>0.0.0.0:8000</code>. Great, our app is running. Let's check our admin panel now at <code>0.0.0.0:8000/admin</code>. Awesome,
styles are there! We have achieved what we wanted. Congratulations!</p>
<p>This is just the tip of the iceberg. You will need more stuff as your app grows. Go to <a href="https://nginx.org/en/docs/">nginx docs</a> to learn more.</p>
<p>In the next tutorial, we will take a look at <code>supervisord</code> to make process management very easy.</p>
<p>Fight on!</p>
<p><a href="http://rahmonov.me/posts/run-a-django-app-with-gunicorn-in-ubuntu-16-04/">Part I</a></p>
<p><a href="http://rahmonov.me/posts/run-a-django-app-with-nginx-gunicorn-and-supervisor/">Part III</a></p>
  </div>

<div class="end">
    <span>
        If you liked what you read, I would really appreciate if you could endorse me on
        <a href="https://www.linkedin.com/in/jahongirrahmonov/">LinkedIn</a>
    </span>
</div>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'jrahmonov';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
        </div>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67392250-1', 'auto');
      ga('send', 'pageview');
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="/static/js/mobile.js"></script>

</body>
</html>